<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Felix DB (V35 Debug)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f8fafc; color: #334155; }
        .custom-scrollbar::-webkit-scrollbar { height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .animate-slideIn { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input, select, textarea { font-size: 16px !important; } 
        .section-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; font-weight: 700; margin-bottom: 0.75rem; }
        .policy-detail-box { @apply mt-2 ml-1 p-3 bg-slate-100 rounded-lg border border-slate-200 text-sm grid grid-cols-1 sm:grid-cols-3 gap-2 animate-slideIn; }
        
        /* Debug Console Style */
        #debug-console { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #991b1b; color: white; padding: 20px; z-index: 9999; font-family: monospace; font-size: 12px; white-space: pre-wrap; height: 200px; overflow: auto; opacity: 0.95; }
    </style>
</head>
<body>

    <!-- é™¤éŒ¯è¦–çª—ï¼šå¦‚æœ React å´©æ½°ï¼Œé€™è£¡æœƒé¡¯ç¤ºéŒ¯èª¤ -->
    <div id="debug-console"></div>
    <div id="root"></div>

    <script>
        // å…¨å±€éŒ¯èª¤æ””æˆªå™¨ (Global Error Trap)
        window.onerror = function(msg, url, line, col, error) {
            const debugEl = document.getElementById('debug-console');
            debugEl.style.display = 'block';
            debugEl.innerHTML += `[CRITICAL ERROR] ${msg}\nLine: ${line}\n${error?.stack || ''}\n\n`;
            return false;
        };
        window.onunhandledrejection = function(event) {
            const debugEl = document.getElementById('debug-console');
            debugEl.style.display = 'block';
            debugEl.innerHTML += `[PROMISE ERROR] ${event.reason}\n\n`;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, Component } = React;

        // --- å…¨å±€éŒ¯èª¤é‚Šç•Œ ---
        class GlobalErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-8 text-center bg-white border-2 border-red-500 m-4 rounded-xl">
                            <h2 className="text-xl font-bold text-red-600 mb-2">ğŸ˜­ ç¶²é ç™¼ç”ŸéŒ¯èª¤</h2>
                            <p className="text-slate-600 mb-4 text-sm bg-slate-100 p-2 rounded">{this.state.error?.message}</p>
                            <button onClick={() => { localStorage.removeItem('felix_db_config'); window.location.reload(); }} className="bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg font-bold">é‡ç½®ä¸¦æ¸…é™¤è¨­å®š</button>
                            <div className="mt-4 text-xs text-gray-400">è«‹å˜—è©¦é»æ“Šä¸Šæ–¹æŒ‰éˆ•é‡ç½®ï¼Œè‹¥å•é¡ŒæŒçºŒï¼Œè«‹æˆªåœ–æ­¤ç•«é¢ã€‚</div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- ç©©å®šçš„åœ–ç¤ºå…ƒä»¶ ---
        const Icon = ({ name, size = 18, className = "" }) => {
            let path = null;
            switch(name) {
                case 'dashboard': path = <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />; break;
                case 'check': path = <polyline points="20 6 9 17 4 12"/>; break;
                case 'alert': path = <circle cx="12" cy="12" r="10"/>; break;
                case 'upload': path = <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>; break;
                case 'download': path = <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>; break;
                case 'search': path = <g><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></g>; break;
                case 'gift': path = <g><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></g>; break;
                case 'cake': path = <path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5 2 4 2 2-1 2-1M2 21h20M7 8v2M12 8v2M17 8v2M7 4h.01M12 4h.01M17 4h.01"/>; break;
                case 'save': path = <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2zM17 21v-8H7v8M7 3v5h8"/>; break;
                case 'edit': path = <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>; break;
                case 'trash': path = <g><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></g>; break;
                case 'phone': path = <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>; break;
                case 'user': path = <g><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></g>; break;
                case 'reset': path = <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>; break;
                default: path = <circle cx="12" cy="12" r="10"/>;
            }
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {path}
                </svg>
            );
        };

        const SegmentControl = ({ options, value, onChange }) => (
            <div className="flex bg-slate-100 p-1 rounded-lg border border-slate-200">
                {options.map(opt => (
                    <button key={opt.value} type="button" onClick={() => onChange(opt.value)} className={`flex-1 py-2 px-3 text-sm font-medium rounded-md transition-all ${value === opt.value ? 'bg-white text-slate-800 shadow-sm border border-slate-200' : 'text-slate-500 hover:text-slate-700'}`}>{opt.label}</button>
                ))}
            </div>
        );

        const App = () => {
            const [config, setConfig] = useState(null);
            const [user, setUser] = useState(null);
            const [clients, setClients] = useState([]);
            const [loading, setLoading] = useState(true); // Default loading to prevent flicker
            const [error, setError] = useState(null);
            const [currentView, setCurrentView] = useState('entry'); 
            const [editingId, setEditingId] = useState(null);
            const fileInputRef = useRef(null);
            
            const initialFormState = {
                source: 'æœ‹å‹ä»‹ç´¹', referrerName: '', name: '', nickname: '', phone: '', 
                residentialArea: '', hobbies: '', occupation: '', income: '', 
                medicalHistory: '', isClient: 'not_yet',
                appointmentDate: '', clientSinceDate: '', remarks: '',
                birthday: '', policyPremium: '', policyCurrency: 'HKD',
                policyDetails: {},
                policies: { criticalIllness: [], vhis: [], saving: [], accident: [], annuity: [], mpf: false }
            };
            const [formData, setFormData] = useState(initialFormState);
            const [searchTerm, setSearchTerm] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');
            const [sourceFilter, setSourceFilter] = useState('all');
            const [policyFilter, setPolicyFilter] = useState('all');

            const POLICY_OPTIONS = {
                criticalIllness: { label: '1. å±ç–¾', options: ['å±ç–¾æ‡‰æ´ä¿(å‡ç´šç‰ˆ)', 'å±ç–¾æ‡‰æ´ä¿', 'å±ç–¾å…¨å®ˆè¡›ï¼ˆè¶…å“ç‰ˆ)', 'å±ç–¾æ™‰å¾¡ä¿(å°Šå°šç‰ˆ)', 'å±ç–¾ç·»å°šä¿', 'å±ç–¾ç·»å°šä¿(å‡ç´šç‰ˆ)', 'çˆ¶æ¯ä¹‹åŠ æ·»å®ˆè­·é¸é …'] },
                vhis: { label: '2. é†«ä¿', options: ['äººä»ä¿é†«ç™‚ä¿éšªè¨ˆåŠƒ', 'æ˜“è¡›æ‚¨é†«ç™‚è¨ˆåŠƒ', 'å€è¡›æ‚¨é†«ç™‚è¨ˆåŠƒ', 'å°Šè¡›æ‚¨ï¼ˆå¯°è­½ç‰ˆï¼‰é†«ç™‚è¨ˆåŠƒ', 'é†«å®¶ä¿é†«ç™‚è¨ˆåŠƒ'] },
                saving: { label: '3. Saving Plan', options: ['ç›ˆèšâ€§å¤©ä¸‹å£½éšªè¨ˆåŠƒ â€“ 2å¹´ä¾›', 'ç›ˆèšâ€§å¤©ä¸‹å£½éšªè¨ˆåŠƒ â€“ 5å¹´ä¾›', 'ç›ˆèšå„ªè£•å£½éšªè¨ˆåŠƒ - 5å¹´ä¾›', 'ç›ˆèšç’°çƒå£½éšªè¨ˆåŠƒ - 5å¹´ä¾›'] },
                accident: { label: '4. æ„å¤–ä¿éšª', options: ['äººèº«æ„å¤–ä¿éšªé™„ç´„', 'å…¨æ„å®ˆè­·æ„å¤–ä¿éšœè¨ˆåŠƒ', 'å…¨æ„è¡›æ‚¨æ„å¤–ä¿éšœè¨ˆåŠƒ'] },
                annuity: { label: '5. å¹´é‡‘', options: ['ç›ˆâ€¢æ­²æ‚…å»¶æœŸå¹´é‡‘è¨ˆåŠƒ'] }
            };
            const INCOME_OPTIONS = ['<15K', '15K-30K', '30K-40K', '40K-50K', '50K+'];
            const CURRENCY_OPTIONS = ['HKD', 'USD', 'RMB'];

            useEffect(() => {
                const savedConfig = localStorage.getItem('felix_db_config');
                if (savedConfig) {
                    try { initializeFirebase(JSON.parse(savedConfig)); } catch (e) { 
                        setLoading(false);
                        setCurrentView('setup'); 
                    }
                } else { 
                    setLoading(false);
                    setCurrentView('setup'); 
                }
            }, []);

            const initializeFirebase = (firebaseConfig) => {
                try {
                    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                    setConfig(firebaseConfig);
                    const auth = firebase.auth();
                    auth.onAuthStateChanged((u) => {
                        if (u) { setUser(u); fetchClients(u); }
                        else { 
                            auth.signInAnonymously().catch(e => {
                                console.error("Auth Error:", e);
                                setError("ç™»å…¥å¤±æ•—ï¼šè«‹æª¢æŸ¥ Firebase Console > Authentication > Sign-in method æ˜¯å¦å·²å•Ÿç”¨ã€ŒåŒ¿å(Anonymous)ã€\nä»¥åŠ Settings > Authorized domains æ˜¯å¦å·²åŠ å…¥ github.io");
                                setLoading(false);
                            }); 
                        }
                    });
                    if (currentView === 'setup') setCurrentView('entry');
                } catch (err) { 
                    console.error("Init Error:", err);
                    setError("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šç¢¼æ ¼å¼"); 
                    setLoading(false);
                    setCurrentView('setup'); 
                }
            };

            const handleSaveConfig = (str) => {
                try {
                    let clean = str.trim();
                    if (clean.includes('=')) clean = clean.split('=')[1];
                    if (clean.endsWith(';')) clean = clean.slice(0, -1);
                    const parsed = new Function('return ' + clean)();
                    if(!parsed.apiKey) throw new Error("ç¼ºå°‘ apiKey");
                    localStorage.setItem('felix_db_config', JSON.stringify(parsed));
                    initializeFirebase(parsed);
                } catch (e) { alert("è¨­å®šç¢¼æ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¤‡è£½ Firebase Config (JSON)"); }
            };

            const resetSystem = () => {
                if(confirm("ç¢ºå®šè¦é‡ç½®ç³»çµ±è¨­å®šå—ï¼Ÿ")){
                    localStorage.removeItem('felix_db_config');
                    window.location.reload();
                }
            };

            const fetchClients = (u) => {
                setLoading(true);
                firebase.firestore().collection('felix_clients').doc('shared_data').collection('data')
                    .onSnapshot(snap => {
                        const list = snap.docs.map(d => {
                            const data = d.data() || {};
                            // Data Sanitization
                            return {
                                id: d.id,
                                ...data,
                                policies: {
                                    criticalIllness: Array.isArray(data.policies?.criticalIllness) ? data.policies.criticalIllness : [],
                                    vhis: Array.isArray(data.policies?.vhis) ? data.policies.vhis : [],
                                    saving: Array.isArray(data.policies?.saving) ? data.policies.saving : [],
                                    accident: Array.isArray(data.policies?.accident) ? data.policies.accident : [],
                                    annuity: Array.isArray(data.policies?.annuity) ? data.policies.annuity : [],
                                    mpf: !!data.policies?.mpf
                                },
                                policyDetails: data.policyDetails || {},
                                birthday: data.birthday || '',
                                clientSinceDate: data.clientSinceDate || data.policyEffectiveDate || '',
                                createdAt: data.createdAt || { toDate: () => new Date() },
                                updatedAt: data.updatedAt || { toDate: () => new Date() }
                            };
                        });
                        
                        list.sort((a, b) => {
                            const da = a.updatedAt.toDate ? a.updatedAt.toDate() : new Date();
                            const db = b.updatedAt.toDate ? b.updatedAt.toDate() : new Date();
                            return db - da;
                        });

                        setClients(list);
                        setLoading(false);
                    }, err => { 
                        console.error("Snapshot Error:", err);
                        setError("ç„¡æ³•è®€å–è³‡æ–™åº« (Permission Denied)ã€‚è«‹ç¢ºèª Firebase Console > Firestore Database > Rules æ˜¯å¦å·²è¨­å®šç‚º 'allow read, write: if true;' (æ¸¬è©¦æ¨¡å¼)");
                        setLoading(false);
                    });
            };

            const handleInputChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });
            
            const handlePolicyDetailChange = (policyName, field, value) => {
                setFormData(prev => {
                    const currentDetails = prev.policyDetails || {};
                    const policySpecific = currentDetails[policyName] || { premium: '', currency: 'HKD', policyNo: '' };
                    return { ...prev, policyDetails: { ...currentDetails, [policyName]: { ...policySpecific, [field]: value } } };
                });
            };

            const handlePolicyArrayChange = (cat, opt) => {
                setFormData(prev => {
                    const currentArr = Array.isArray(prev.policies[cat]) ? prev.policies[cat] : [];
                    let newArr = currentArr.includes(opt) ? currentArr.filter(i=>i!==opt) : [...currentArr, opt];
                    if (cat === 'criticalIllness') {
                        if (opt === 'å±ç–¾æ‡‰æ´ä¿(å‡ç´šç‰ˆ)' && newArr.includes('å±ç–¾æ‡‰æ´ä¿(å‡ç´šç‰ˆ)')) newArr = newArr.filter(i => i !== 'å±ç–¾æ‡‰æ´ä¿');
                        if (opt === 'å±ç–¾ç·»å°šä¿(å‡ç´šç‰ˆ)' && newArr.includes('å±ç–¾ç·»å°šä¿(å‡ç´šç‰ˆ)')) newArr = newArr.filter(i => i !== 'å±ç–¾ç·»å°šä¿');
                    }
                    return { ...prev, policies: { ...prev.policies, [cat]: newArr } };
                });
            };

            const handlePolicyBoolChange = (cat) => setFormData(prev => ({ ...prev, policies: { ...prev.policies, [cat]: !prev.policies[cat] } }));

            const getSourceStyle = (source) => {
                switch(source) {
                    case 'æœ‹å‹ä»‹ç´¹': return 'bg-blue-100 text-blue-700 border-blue-200';
                    case 'Bigboss': return 'bg-purple-100 text-purple-700 border-purple-200';
                    case 'è‡ªå·±æœ‹å‹': return 'bg-amber-100 text-amber-700 border-amber-200';
                    default: return 'bg-slate-100 text-slate-600 border-slate-200';
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user) return;
                const db = firebase.firestore().collection('felix_clients').doc('shared_data').collection('data');
                let data = { ...formData };
                if (data.source !== 'æœ‹å‹ä»‹ç´¹') data.referrerName = '';
                if (data.isClient === 'not_yet') { data.policies = initialFormState.policies; data.clientSinceDate = ''; data.policyDetails = {}; }
                else { data.appointmentDate = ''; }

                try {
                    const now = new Date();
                    if (editingId) {
                        await db.doc(editingId).update({ ...data, updatedAt: now });
                        alert("æ›´æ–°æˆåŠŸ");
                    } else {
                        const cleanPhone = String(data.phone).replace(/\D/g, '');
                        const duplicate = clients.find(c => c.name === data.name && String(c.phone).replace(/\D/g, '') === cleanPhone);
                        if (duplicate) {
                            if (confirm(`åµæ¸¬åˆ°é‡è¤‡å®¢æˆ¶ï¼š${data.name}\næ˜¯å¦æ›´æ–°ç¾æœ‰è³‡æ–™ï¼Ÿ`)) {
                                await db.doc(duplicate.id).update({ ...data, updatedAt: now });
                                alert("å·²åˆä½µæ›´æ–°");
                            } else { return; }
                        } else {
                            await db.add({ ...data, createdAt: now, updatedAt: now });
                            alert("æ–°å¢æˆåŠŸ");
                        }
                    }
                    handleCancelEdit();
                } catch (err) { alert("å„²å­˜å¤±æ•—: " + err.message); }
            };

            const handleDelete = async (id) => {
                if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
                    await firebase.firestore().collection('felix_clients').doc('shared_data').collection('data').doc(id).delete();
                    if(editingId === id) handleCancelEdit();
                }
            };

            const handleEdit = (c) => {
                setCurrentView('entry');
                const dateVal = c.clientSinceDate || c.policyEffectiveDate || '';
                const safePolicies = JSON.parse(JSON.stringify(c.policies));
                const safeDetails = JSON.parse(JSON.stringify(c.policyDetails));
                const safeData = { ...initialFormState, ...c, policies: safePolicies, clientSinceDate: dateVal, policyDetails: safeDetails };
                setFormData(safeData);
                setEditingId(c.id);
                window.scrollTo({top:0, behavior:'smooth'});
            };
            const handleCancelEdit = () => { setFormData(initialFormState); setEditingId(null); };

            const formatDate = (ts) => {
                if (!ts) return '-';
                try {
                    const d = ts.toDate ? ts.toDate() : new Date(ts);
                    if (isNaN(d.getTime())) return '-';
                    return d.toLocaleString('zh-HK', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
                } catch(e) { return '-'; }
            };

            const parseExcelDate = (value) => {
                if (!value) return '';
                if (typeof value === 'number') {
                    const date = new Date(Math.round((value - 25569) * 86400 * 1000));
                    date.setMinutes(date.getMinutes() + date.getTimezoneOffset()); 
                    return date.toISOString().split('T')[0];
                }
                const d = new Date(value);
                return !isNaN(d.getTime()) ? d.toISOString().split('T')[0] : '';
            };

            const findValue = (row, possibleKeys) => {
                const keys = Object.keys(row);
                for (let pk of possibleKeys) {
                    const foundKey = keys.find(k => k.toLowerCase().includes(pk.toLowerCase()));
                    if (foundKey) return row[foundKey];
                }
                return '';
            };

            const exportToCSV = () => {
                let csv = "å§“å,æš±ç¨±,é›»è©±,ç”Ÿæ—¥,ä¾†æº,ä»‹ç´¹äºº,åœ°å€,èˆˆè¶£,è·æ¥­,æ”¶å…¥,ç‹€æ…‹,é ç´„æ—¥æœŸ,æˆç‚ºå®¢æˆ¶æ—¥æœŸ,ä¿å–®æ˜ç´°,ç—…æ­·,å‚™è¨»,å»ºç«‹æ™‚é–“,æœ€å¾Œä¿®æ”¹\n";
                filteredClients.forEach(c => {
                    let polStr = "";
                    if (c.isClient === 'already') {
                        const p = c.policies || {};
                        const d = c.policyDetails || {};
                        const arr = [...(p.criticalIllness || []), ...(p.vhis || []), ...(p.saving || []), ...(p.accident || []), ...(p.annuity || []), p.mpf ? "MPF" : ""];
                        polStr = arr.filter(Boolean).map(name => {
                            const detail = d[name];
                            if (detail && (detail.premium || detail.policyNo)) return `${name}(${detail.currency}$${detail.premium || '-'} #${detail.policyNo || '-'})`;
                            return name;
                        }).join(" / ");
                    }
                    const createdStr = formatDate(c.createdAt);
                    const updatedStr = formatDate(c.updatedAt);
                    const sinceDate = c.clientSinceDate || "-";
                    const row = [c.name, c.nickname||"-", `'${c.phone}`, c.birthday||"-", c.source, c.referrerName||"-", c.residentialArea||"-", c.hobbies?`"${c.hobbies}"`:"-", c.occupation||"-", c.income||"-", c.isClient==='already'?"å·²æˆäº¤":"æ½›åœ¨", c.appointmentDate||"-", sinceDate, `"${polStr}"`, c.medicalHistory?`"${c.medicalHistory}"`:"-", c.remarks?`"${c.remarks}"`:"-", createdStr, updatedStr];
                    csv += row.join(",") + "\n";
                });
                const link = document.createElement("a");
                link.href = encodeURI("data:text/csv;charset=utf-8,\uFEFF"+csv);
                link.download = `Felix_DB_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const handleImportClick = () => fileInputRef.current.click();

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        setLoading(true);
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: true });
                        const db = firebase.firestore().collection('felix_clients').doc('shared_data').collection('data');
                        
                        let addedCount = 0; let updatedCount = 0;
                        const batchOperations = new Map();
                        
                        clients.forEach(c => {
                             const key = `${c.name}_${String(c.phone).replace(/\D/g, '')}`;
                             batchOperations.set(key, { ...c, existingId: c.id });
                        });

                        for (const row of rawData) {
                            const name = findValue(row, ['name', 'å§“å', 'å®¢æˆ¶']) || '';
                            let phone = findValue(row, ['phone', 'tel', 'mobile', 'é›»è©±']) || '';
                            phone = String(phone).replace(/['\s-]/g, ''); 
                            const cleanPhone = phone.replace(/\D/g, '');
                            if (!name || !cleanPhone) continue;

                            const uniqueKey = `${name}_${cleanPhone}`;
                            const nickname = findValue(row, ['nickname', 'nick', 'èŠ±å', 'æš±ç¨±']) || '';
                            const birthday = parseExcelDate(findValue(row, ['birthday', 'dob', 'birth', 'ç”Ÿæ—¥']));
                            const policyStr = String(findValue(row, ['ä¿éšœåç¨±', 'ä¿éšœ', 'ä¿å–®', 'policy', 'plan']) || '');
                            const remarksStr = findValue(row, ['remarks', 'note', 'å‚™è¨»']) || '';
                            const occupation = findValue(row, ['job', 'occupation', 'è·æ¥­']) || '';
                            const income = findValue(row, ['income', 'salary', 'æ”¶å…¥']) || '';
                            const joinDate = parseExcelDate(findValue(row, ['ç”Ÿæ•ˆ', 'æˆç‚ºå®¢æˆ¶', 'effective', 'join']));
                            const premium = findValue(row, ['æ¯æœŸä¿è²»', 'ä¿è²»', 'premium']) || '';
                            const currency = findValue(row, ['è²¨å¹£', 'currency']) || 'HKD';
                            const policyNo = findValue(row, ['ä¿å–®ç·¨è™Ÿ', 'ä¿å–®è™Ÿç¢¼', 'policy no', 'policy number']);

                            let clientData = {
                                name, phone, nickname, birthday, occupation, income,
                                isClient: 'already',
                                policies: { criticalIllness: [], vhis: [], saving: [], accident: [], annuity: [], mpf: false },
                                policyDetails: {},
                                remarks: remarksStr,
                                clientSinceDate: joinDate || '',
                                existingId: null
                            };

                            if (policyNo) {
                                const noStr = `[ä¿å–®è™Ÿ: ${policyNo}]`;
                                clientData.remarks = clientData.remarks ? `${clientData.remarks} ${noStr}` : noStr;
                            }

                            if (policyStr) {
                                if (policyStr.toUpperCase().includes('MPF')) clientData.policies.mpf = true;
                                const categories = ['criticalIllness', 'vhis', 'saving', 'accident', 'annuity'];
                                categories.forEach(cat => {
                                    POLICY_OPTIONS[cat].options.forEach(option => {
                                        if (policyStr.includes(option)) {
                                            clientData.policies[cat].push(option);
                                            if (premium || policyNo) {
                                                clientData.policyDetails[option] = { premium: premium, currency: currency, policyNo: policyNo };
                                            }
                                        }
                                    });
                                });
                                // Logic
                                if (clientData.policies.criticalIllness.includes('å±ç–¾æ‡‰æ´ä¿(å‡ç´šç‰ˆ)')) clientData.policies.criticalIllness = clientData.policies.criticalIllness.filter(p => p !== 'å±ç–¾æ‡‰æ´ä¿');
                                if (clientData.policies.criticalIllness.includes('å±ç–¾ç·»å°šä¿(å‡ç´šç‰ˆ)')) clientData.policies.criticalIllness = clientData.policies.criticalIllness.filter(p => p !== 'å±ç–¾ç·»å°šä¿');

                                const hasMatch = categories.some(cat => clientData.policies[cat].length > 0) || clientData.policies.mpf;
                                if (!hasMatch && policyStr.length > 1) {
                                    clientData.remarks = clientData.remarks ? `${clientData.remarks} [ä¿å–®: ${policyStr}]` : `[ä¿å–®: ${policyStr}]`;
                                }
                            }

                            const prevData = batchOperations.get(uniqueKey);
                            if (prevData) {
                                if (!prevData.birthday && clientData.birthday) prevData.birthday = clientData.birthday;
                                if (!prevData.nickname && clientData.nickname) prevData.nickname = clientData.nickname;
                                if (!prevData.clientSinceDate && clientData.clientSinceDate) prevData.clientSinceDate = clientData.clientSinceDate;
                                ['criticalIllness', 'vhis', 'saving', 'accident', 'annuity'].forEach(cat => {
                                    prevData.policies[cat] = [...new Set([...(prevData.policies[cat]||[]), ...clientData.policies[cat]])];
                                });
                                prevData.policies.mpf = prevData.policies.mpf || clientData.policies.mpf;
                                prevData.policyDetails = { ...prevData.policyDetails, ...clientData.policyDetails };
                                if (clientData.remarks && !(prevData.remarks||'').includes(clientData.remarks)) prevData.remarks += `\n${clientData.remarks}`;
                                batchOperations.set(uniqueKey, prevData);
                            } else {
                                batchOperations.set(uniqueKey, clientData);
                            }
                        }

                        const now = new Date();
                        for (const [key, data] of batchOperations) {
                            const { existingId, ...payload } = data;
                            payload.updatedAt = now;
                            if (existingId) {
                                await db.doc(existingId).update(payload);
                            } else {
                                payload.createdAt = now;
                                await db.add(payload);
                                addedCount++;
                            }
                        }
                        alert(`åŒ¯å…¥å®Œæˆï¼æ–°å¢ ${addedCount} ç­†`);
                    } catch (err) { alert("åŒ¯å…¥éŒ¯èª¤: " + err.message); } finally { setLoading(false); e.target.value = ''; }
                };
                reader.readAsArrayBuffer(file);
            };

            const getUpcomingBirthdays = (list) => {
                if (!list || list.length === 0) return [];
                const today = new Date(); today.setHours(0,0,0,0);
                const sevenDaysLater = new Date(today); sevenDaysLater.setDate(today.getDate() + 7);
                return list.filter(c => {
                    if(!c.birthday) return false;
                    const bDate = new Date(c.birthday);
                    const thisYearBday = new Date(today.getFullYear(), bDate.getMonth(), bDate.getDate());
                    if (thisYearBday < today) thisYearBday.setFullYear(today.getFullYear() + 1);
                    const diffTime = Math.abs(thisYearBday - today);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    return diffDays >= 0 && diffDays <= 7;
                }).map(c => {
                    const bDate = new Date(c.birthday);
                    const thisYearBday = new Date(today.getFullYear(), bDate.getMonth(), bDate.getDate());
                    if (thisYearBday < today) thisYearBday.setFullYear(today.getFullYear() + 1);
                    const diffDays = Math.ceil((thisYearBday - today) / (1000 * 60 * 60 * 24));
                    return { ...c, displayDate: `${bDate.getMonth() + 1}æœˆ${bDate.getDate()}æ—¥`, daysUntil: diffDays };
                });
            };

            const filteredClients = clients.filter(c => {
                const s = searchTerm.toLowerCase();
                const mSearch = (c.name||'').toLowerCase().includes(s) || (c.phone||'').includes(s) || (c.nickname||'').toLowerCase().includes(s) || (c.occupation||'').includes(s);
                const mStatus = statusFilter === 'all' || c.isClient === statusFilter;
                const mSource = sourceFilter === 'all' || c.source === sourceFilter;
                let mPolicy = true;
                if(policyFilter !== 'all') {
                    if(c.isClient !== 'already') mPolicy = false;
                    else {
                        const p = c.policies || {};
                        if(policyFilter === 'criticalIllness') mPolicy = p.criticalIllness?.length > 0;
                        else if(policyFilter === 'vhis') mPolicy = p.vhis?.length > 0;
                        else if(policyFilter === 'saving') mPolicy = p.saving?.length > 0;
                        else if(policyFilter === 'annuity') mPolicy = p.annuity?.length > 0;
                        else if(policyFilter === 'accident') mPolicy = p.accident?.length > 0;
                        else mPolicy = p[policyFilter] === true;
                    }
                }
                return mSearch && mStatus && mSource && mPolicy;
            });

            const upcomingBirthdays = getUpcomingBirthdays(clients);

            const renderPolicyInputs = (policyName) => {
                const details = (formData.policyDetails && formData.policyDetails[policyName]) || {};
                return (
                    <div className="policy-detail-box">
                        <input placeholder="æ¯æœŸä¿è²»" type="number" value={details.premium || ''} onChange={(e) => handlePolicyDetailChange(policyName, 'premium', e.target.value)} className="w-full border rounded p-1.5 focus:border-indigo-500 outline-none" />
                        <select value={details.currency || 'HKD'} onChange={(e) => handlePolicyDetailChange(policyName, 'currency', e.target.value)} className="w-full border rounded p-1.5 bg-white focus:border-indigo-500 outline-none">
                            {CURRENCY_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                        <input placeholder="ä¿å–®è™Ÿç¢¼" value={details.policyNo || ''} onChange={(e) => handlePolicyDetailChange(policyName, 'policyNo', e.target.value)} className="w-full border rounded p-1.5 focus:border-indigo-500 outline-none" />
                    </div>
                );
            };

            if (currentView === 'setup') {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-900 p-6">
                        <div className="bg-white p-8 rounded-xl w-full max-w-md shadow-2xl border border-slate-700">
                            <h1 className="text-2xl font-bold mb-2 text-slate-800 tracking-tight">Felix DB Setup</h1>
                            <p className="text-sm text-slate-500 mb-6">è«‹è¼¸å…¥ Firebase è¨­å®šç¢¼</p>
                            <form onSubmit={e => {e.preventDefault(); handleSaveConfig(e.target.conf.value)}}>
                                <textarea name="conf" rows="8" className="w-full border border-slate-300 p-3 text-xs mb-4 rounded-lg font-mono bg-slate-50 focus:ring-2 focus:ring-slate-500 outline-none" placeholder='{ "apiKey": "...", ... }' required></textarea>
                                <button className="w-full bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-lg font-bold shadow-lg transition-transform active:scale-95">å•Ÿå‹•ç³»çµ±</button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <GlobalErrorBoundary>
                    <div className="min-h-screen flex flex-col max-w-md mx-auto md:max-w-5xl md:px-4">
                        <header className="bg-slate-900 text-white py-4 px-5 sticky top-0 z-50 md:mt-4 md:rounded-xl shadow-lg flex justify-between items-center backdrop-blur-md bg-opacity-95">
                            <div className="flex items-center gap-3">
                                <div className="p-1.5 bg-slate-800 rounded-lg border border-slate-700"><Icon name="dashboard" className="text-emerald-400" /></div>
                                <div><h1 className="font-bold text-lg tracking-wide leading-none">Felix DB</h1><p className="text-[10px] text-slate-400 uppercase tracking-widest mt-0.5">Professional CRM (V35)</p></div>
                            </div>
                            <div className="flex bg-slate-800 p-1 rounded-lg border border-slate-700">
                                <button onClick={()=>setCurrentView('entry')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${currentView==='entry'?'bg-slate-600 text-white shadow-sm':'text-slate-400 hover:text-white'}`}>æ–°å¢</button>
                                <button onClick={()=>setCurrentView('database')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${currentView==='database'?'bg-slate-600 text-white shadow-sm':'text-slate-400 hover:text-white'}`}>åˆ—è¡¨</button>
                                <button onClick={resetSystem} className="ml-2 text-slate-400 hover:text-red-400" title="é‡ç½®ç³»çµ±"><Icon name="reset"/></button>
                            </div>
                        </header>

                        <main className="flex-1 py-6 px-4 md:px-0 pb-24">
                            {loading && <div className="text-center py-10 text-slate-500 font-medium animate-pulse">è™•ç†ä¸­...</div>}
                            
                            {!loading && error && (
                                <div className="p-6 text-center bg-red-50 rounded-xl border border-red-200 m-4">
                                    <h3 className="text-red-600 font-bold mb-2">ç„¡æ³•é€£ç·šåˆ°è³‡æ–™åº«</h3>
                                    <p className="text-sm text-gray-600 mb-4">{error}</p>
                                    <button onClick={resetSystem} className="bg-red-600 text-white px-4 py-2 rounded text-sm">é‡ç½®è¨­å®š</button>
                                </div>
                            )}
                            
                            {!loading && !error && currentView === 'entry' && (
                                <form onSubmit={handleSubmit} className="animate-slideIn max-w-2xl mx-auto space-y-6">
                                    <div className="flex justify-between items-center"><h2 className="text-xl font-bold text-slate-800 flex items-center"><span className={`w-2 h-6 mr-3 rounded-full ${editingId ? 'bg-amber-500' : 'bg-slate-800'}`}></span>{editingId ? 'ç·¨è¼¯å®¢æˆ¶æª”æ¡ˆ' : 'å»ºç«‹æ–°å®¢æˆ¶'}</h2>{editingId && <button type="button" onClick={handleCancelEdit} className="text-xs bg-white border border-slate-300 px-3 py-1.5 rounded shadow-sm hover:bg-slate-50">å–æ¶ˆç·¨è¼¯</button>}</div>
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                        <div className="section-title">åŸºæœ¬è³‡è¨Š</div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                                            <div><label className="block text-sm font-semibold text-slate-700 mb-1.5">å®¢æˆ¶å§“å</label><input name="name" value={formData.name} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:bg-white" placeholder="è«‹è¼¸å…¥å§“å" required /></div>
                                            <div><label className="block text-sm font-semibold text-slate-700 mb-1.5">é›»è©±è™Ÿç¢¼</label><input name="phone" type="tel" value={formData.phone} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:bg-white" placeholder="09xx xxx xxx" required /></div>
                                        </div>
                                        <div className="mb-5"><label className="block text-sm font-semibold text-slate-700 mb-1.5">æš±ç¨± (èŠ±å)</label><input name="nickname" value={formData.nickname} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:bg-white" placeholder="ä¾‹å¦‚ï¼šFelix" /></div>
                                        <div className="mb-5"><label className="block text-sm font-semibold text-slate-700 mb-1.5">ç”Ÿæ—¥</label><input type="date" name="birthday" value={formData.birthday} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:bg-white" /></div>
                                        <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-5">
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">èªè­˜ä¾†æº</label>
                                            <select name="source" value={formData.source} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-2.5 bg-white mb-3"><option>æœ‹å‹ä»‹ç´¹</option><option>Bigboss</option><option>è‡ªå·±æœ‹å‹</option><option>å…¶ä»–</option></select>
                                            {formData.source === 'æœ‹å‹ä»‹ç´¹' && (<div className="animate-slideIn"><input name="referrerName" value={formData.referrerName} onChange={handleInputChange} className="w-full border border-indigo-200 rounded-lg p-2.5 bg-indigo-50 focus:bg-white text-indigo-900 placeholder-indigo-300" placeholder="è¼¸å…¥ä»‹ç´¹äººå§“å" /></div>)}
                                        </div>
                                        <div className="grid grid-cols-2 gap-5">
                                            <div><label className="block text-sm font-semibold text-slate-700 mb-1.5">å±…ä½åœ°å€</label><input name="residentialArea" value={formData.residentialArea} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:bg-white" /></div>
                                            <div><label className="block text-sm font-semibold text-slate-700 mb-1.5">èˆˆè¶£å—œå¥½</label><input name="hobbies" value={formData.hobbies} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:bg-white" /></div>
                                        </div>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                        <div className="section-title">èƒŒæ™¯èˆ‡å¥åº·</div>
                                        <div className="grid grid-cols-2 gap-5 mb-5">
                                            <div><label className="block text-sm font-semibold text-slate-700 mb-1.5">è·æ¥­</label><input name="occupation" value={formData.occupation} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:bg-white" /></div>
                                            <div><label className="block text-sm font-semibold text-slate-700 mb-1.5">æ”¶å…¥ç‹€æ³</label><select name="income" value={formData.income} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:bg-white"><option value="">é¸æ“‡ç´šè·...</option>{INCOME_OPTIONS.map(o=><option key={o} value={o}>{o}</option>)}</select></div>
                                        </div>
                                        <div><label className="block text-sm font-semibold text-slate-700 mb-1.5">ç—…æ­·è³‡æ–™</label><textarea name="medicalHistory" value={formData.medicalHistory} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-3 bg-slate-50 focus:bg-white h-24 text-sm leading-relaxed" placeholder="è«‹è©³ç´°è¨˜éŒ„æ—¢å¾€ç—‡æˆ–é«”æ³..."></textarea></div>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                        <div className="section-title">éŠ·å”®é€²åº¦</div>
                                        <div className="mb-6"><SegmentControl options={[{label: 'æ½›åœ¨å®¢æˆ¶', value: 'not_yet'}, {label: 'å·²æˆäº¤', value: 'already'}]} value={formData.isClient} onChange={(val) => setFormData({...formData, isClient: val})} /></div>
                                        {formData.isClient === 'already' ? (
                                            <div className="bg-slate-50 border border-slate-200 rounded-xl p-5 animate-slideIn">
                                                <div className="mb-5"><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">æˆç‚ºå®¢æˆ¶æ—¥æœŸ</label><input type="date" name="clientSinceDate" value={formData.clientSinceDate} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-2.5 bg-white" /></div>
                                                
                                                {/* V29 Policy Loop with Detail Inputs */}
                                                {['criticalIllness','vhis','saving','accident','annuity'].map(k => (
                                                    <div key={k} className="policy-group">
                                                        <p className="text-xs font-bold text-slate-800 mb-2">{POLICY_OPTIONS[k].label}</p>
                                                        <div className="space-y-2">
                                                            {POLICY_OPTIONS[k].options.map(o=>(
                                                                <div key={o}>
                                                                    <label className={`flex items-start p-2 rounded border cursor-pointer transition-all ${formData.policies[k].includes(o) ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-slate-200 hover:border-slate-300'}`}>
                                                                        <input type="checkbox" checked={formData.policies[k].includes(o)} onChange={()=>handlePolicyArrayChange(k,o)} className="mt-1 hidden"/>
                                                                        <div className={`w-4 h-4 min-w-[1rem] rounded border flex items-center justify-center mr-2 mt-0.5 ${formData.policies[k].includes(o) ? 'bg-indigo-600 border-indigo-600' : 'border-slate-300'}`}>{formData.policies[k].includes(o) && <Icon name="check" size={12} className="text-white"/>}</div>
                                                                        <span className="text-sm font-medium leading-tight">{o}</span>
                                                                    </label>
                                                                    {formData.policies[k].includes(o) && renderPolicyInputs(o)}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                                <div className="pt-2">
                                                    <label className={`flex items-center justify-center p-3 rounded border cursor-pointer transition-all ${formData.policies.mpf ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-slate-200'}`}>
                                                        <input type="checkbox" checked={formData.policies.mpf} onChange={()=>handlePolicyBoolChange('mpf')} className="hidden"/>
                                                        <span className="text-sm font-bold">MPF</span>
                                                    </label>
                                                    {formData.policies.mpf && renderPolicyInputs('MPF')}
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="animate-slideIn"><label className="block text-sm font-bold text-amber-600 mb-1.5">é ç´„è¦‹é¢æ—¥æœŸ</label><input type="date" name="appointmentDate" value={formData.appointmentDate} onChange={handleInputChange} className="w-full border border-amber-200 rounded-lg p-2.5 bg-amber-50 focus:bg-white text-amber-900" /></div>
                                        )}
                                    </div>
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><label className="block text-sm font-semibold text-slate-700 mb-1.5">å‚™è¨»äº‹é …</label><textarea name="remarks" value={formData.remarks} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-3 bg-slate-50 focus:bg-white h-24 text-sm" placeholder="å…¶ä»–é‡è¦è¨˜äº‹..."></textarea></div>
                                    <div className="sticky bottom-4 pt-2"><button className={`w-full py-3.5 text-white font-bold rounded-xl shadow-lg text-lg transition-all active:scale-95 flex items-center justify-center ${editingId ? 'bg-amber-500 hover:bg-amber-600 shadow-amber-200' : 'bg-slate-800 hover:bg-slate-900 shadow-slate-300'}`}><Icon name="save" className="mr-2"/> {editingId ? 'æ›´æ–°è³‡æ–™' : 'å„²å­˜è³‡æ–™'}</button></div>
                                </form>
                            )}

                            {!loading && !error && currentView === 'database' && (
                                <div className="space-y-6 pb-20 max-w-4xl mx-auto">
                                    {upcomingBirthdays.length > 0 && (
                                        <div className="bg-white rounded-xl shadow-sm border border-pink-100 overflow-hidden animate-slideIn">
                                            <div className="bg-gradient-to-r from-pink-50 to-white px-4 py-3 border-b border-pink-100 flex items-center"><Icon name="gift" className="text-pink-500 mr-2"/><h3 className="font-bold text-slate-800 text-sm">è¿‘æœŸç”Ÿæ—¥æé†’ (7å¤©å…§)</h3></div>
                                            <div className="p-4 flex gap-3 overflow-x-auto custom-scrollbar">{upcomingBirthdays.map(c => (
                                                <div key={c.id} className="min-w-[150px] bg-pink-50/50 border border-pink-100 rounded-lg p-3 flex flex-col">
                                                    <div className="font-bold text-slate-700">{c.name} {c.nickname && <span className="text-[10px]">({c.nickname})</span>}</div>
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <div className="text-xs text-pink-500 font-bold flex items-center"><Icon name="cake" size={12} className="mr-1"/>{c.displayDate}</div>
                                                        <div className={`text-[10px] font-bold px-1.5 py-0.5 rounded-full ${c.daysUntil === 0 ? 'bg-red-500 text-white' : 'bg-pink-100 text-pink-600'}`}>{c.daysUntil === 0 ? 'ä»Šæ—¥!' : `${c.daysUntil}å¤©`}</div>
                                                    </div>
                                                    <div className="text-xs font-mono text-slate-500 mb-2">{c.phone}</div>
                                                    <a href={`tel:${c.phone}`} className="mt-auto bg-white border border-pink-200 text-pink-600 text-xs font-bold py-1.5 px-2 rounded flex items-center justify-center shadow-sm">è‡´é›»</a>
                                                </div>
                                            ))}</div>
                                        </div>
                                    )}
                                    <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 space-y-4">
                                        <div className="relative"><div className="absolute left-3 top-3 text-slate-400"><Icon name="search"/></div><input placeholder="æœå°‹å§“åã€æš±ç¨±ã€é›»è©±..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} className="w-full border border-slate-200 rounded-lg pl-10 p-2.5 bg-slate-50 focus:bg-white outline-none" /></div>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                            <select value={sourceFilter} onChange={(e) => setSourceFilter(e.target.value)} className="border border-slate-200 rounded-lg p-2 text-sm bg-white"><option value="all">ä¾†æº: å…¨éƒ¨</option><option value="æœ‹å‹ä»‹ç´¹">æœ‹å‹ä»‹ç´¹</option><option value="Bigboss">Bigboss</option><option value="è‡ªå·±æœ‹å‹">è‡ªå·±æœ‹å‹</option><option value="å…¶ä»–">å…¶ä»–</option></select>
                                            <select value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)} className="border border-slate-200 rounded-lg p-2 text-sm bg-white"><option value="all">ç‹€æ…‹: å…¨éƒ¨</option><option value="already">å·²æˆäº¤</option><option value="not_yet">æ½›åœ¨</option></select>
                                            <select value={policyFilter} onChange={(e) => setPolicyFilter(e.target.value)} className="border border-slate-200 rounded-lg p-2 text-sm bg-white text-indigo-700 font-medium md:col-span-2"><option value="all">ä¿å–®: å…¨éƒ¨</option><option value="criticalIllness">å±ç–¾</option><option value="vhis">é†«ä¿</option><option value="saving">Saving</option><option value="annuity">å¹´é‡‘</option><option value="accident">æ„å¤–</option><option value="mpf">MPF</option></select>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={exportToCSV} className="flex-1 bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 py-2.5 rounded-lg text-sm font-bold flex items-center justify-center shadow-sm transition-all"><Icon name="download" className="mr-2"/>åŒ¯å‡º Excel</button>
                                            <button onClick={handleImportClick} className="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2.5 rounded-lg text-sm font-bold flex items-center justify-center shadow transition-all"><Icon name="upload" className="mr-2"/>åŒ¯å…¥ Excel</button>
                                            <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".xlsx, .xls" className="hidden" />
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        {filteredClients.length === 0 ? <div className="text-center text-slate-400 py-12 bg-white rounded-xl border border-dashed border-slate-300">æ²’æœ‰ç¬¦åˆçš„è³‡æ–™</div> : filteredClients.map(c => (
                                            <ClientCard key={c.id} c={c} onEdit={handleEdit} onDelete={handleDelete} getSourceStyle={getSourceStyle} />
                                        ))}
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>
                </GlobalErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>