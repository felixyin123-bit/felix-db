<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Felix DB (V40.7 Full Stats)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f8fafc; color: #334155; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .animate-slideIn { animation: slideIn 0.3s ease-out; }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
        .animate-popIn { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .animate-slideUp { animation: slideUp 0.3s ease-out; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        input, select, textarea { font-size: 16px !important; } 
        .section-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; font-weight: 700; margin-bottom: 0.75rem; }
        .policy-detail-box { @apply mt-2 ml-1 p-3 bg-slate-100 rounded-lg border border-slate-200 text-sm grid grid-cols-1 sm:grid-cols-3 gap-2 animate-slideIn; }
        
        /* Skeleton Animation */
        .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        /* Safe Area */
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, Component } = React;

        // --- 1. 全域錯誤邊界 ---
        class GlobalErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-slate-50 p-6">
                            <div className="bg-white p-8 rounded-xl shadow-xl border border-red-100 max-w-md w-full text-center">
                                <h2 className="text-xl font-bold text-red-600 mb-2">⚠️ 系統發生錯誤</h2>
                                <p className="text-slate-500 mb-6 text-sm">{this.state.error?.message || "未知錯誤"}</p>
                                <div className="space-y-3">
                                    <button onClick={() => window.location.reload()} className="w-full bg-slate-200 text-slate-800 py-3 rounded-lg font-bold">重新整理</button>
                                    <button onClick={() => { localStorage.removeItem('felix_db_config'); window.location.reload(); }} className="w-full bg-red-600 text-white py-3 rounded-lg font-bold shadow-lg">重置並清除設定</button>
                                </div>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- 2. 圖示 ---
        const IconPaths = {
            dashboard: <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />,
            check: <polyline points="20 6 9 17 4 12"/>,
            alert: <circle cx="12" cy="12" r="10"/>,
            upload: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>,
            download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>,
            search: <g><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></g>,
            gift: <g><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></g>,
            cake: <path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5-2 4-2 2-1 2-1M2 21h20M7 8v2M12 8v2M17 8v2M7 4h.01M12 4h.01M17 4h.01"/>,
            save: <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2zM17 21v-8H7v8M7 3v5h8"/>,
            edit: <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>,
            trash: <g><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></g>,
            phone: <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>,
            user: <g><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></g>,
            reset: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>,
            plus: <path d="M12 5v14M5 12h14"/>,
            calendar: <g><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></g>,
            mapPin: <g><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></g>,
            briefcase: <g><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></g>,
            list: <g><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></g>,
            x: <g><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></g>,
            chevronRight: <polyline points="9 18 15 12 9 6"></polyline>,
            chevronLeft: <polyline points="15 18 9 12 15 6"></polyline>,
            message: <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>,
            clipboard: <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>,
            activity: <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>,
            dollar: <path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>,
            fileText: <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        };

        const Icon = ({ name, size = 18, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {IconPaths[name] || IconPaths.dashboard}
            </svg>
        );

        const ToastContainer = ({ toasts, removeToast }) => (
            <div className="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none">
                {toasts.map(t => (
                    <div key={t.id} className={`pointer-events-auto flex items-center p-4 rounded-lg shadow-lg border animate-slideIn ${t.type === 'error' ? 'bg-red-50 border-red-100 text-red-800' : 'bg-emerald-50 border-emerald-100 text-emerald-800'}`}>
                        <div className={`mr-3 p-1 rounded-full ${t.type === 'error' ? 'bg-red-100' : 'bg-emerald-100'}`}>
                            <Icon name={t.type === 'error' ? 'alert' : 'check'} size={16} />
                        </div>
                        <span className="font-bold text-sm">{t.msg}</span>
                        <button onClick={() => removeToast(t.id)} className="ml-4 opacity-50 hover:opacity-100"><Icon name="x" size={14}/></button>
                    </div>
                ))}
            </div>
        );

        // --- Custom Modal ---
        const Modal = ({ isOpen, title, message, onConfirm, onCancel, confirmText="確定", cancelText="取消", type="danger" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fadeIn">
                    <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 animate-popIn">
                        <h3 className={`text-lg font-bold mb-2 ${type==='danger'?'text-red-600':'text-slate-800'}`}>{title}</h3>
                        <p className="text-slate-600 mb-6 text-sm whitespace-pre-line">{message}</p>
                        <div className="flex gap-3">
                            <button type="button" onClick={onCancel} className="flex-1 py-2.5 bg-slate-100 text-slate-700 rounded-lg font-bold text-sm hover:bg-slate-200">{cancelText}</button>
                            <button type="button" onClick={onConfirm} className={`flex-1 py-2.5 text-white rounded-lg font-bold text-sm shadow-md ${type==='danger'?'bg-red-500 hover:bg-red-600':'bg-indigo-600 hover:bg-indigo-700'}`}>{confirmText}</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Claims Manager Modal ---
        const ClaimsManager = ({ isOpen, client, onClose, onUpdate, showConfirm }) => {
            if (!isOpen || !client) return null;
            
            const [view, setView] = useState('list'); 
            const [activeCase, setActiveCase] = useState(null);
            const [editingCase, setEditingCase] = useState(null);
            const [newCaseData, setNewCaseData] = useState({ type: 'medical', title: '', incidentDate: '', status: 'processing' });
            
            const [newRecordData, setNewRecordData] = useState({ visitDate: '', diagnosis: '', amount: '' });
            const [editingRecordId, setEditingRecordId] = useState(null);

            const claims = client.claims || [];

            const calculateTotal = (c) => {
                return (c.records || []).reduce((acc, curr) => acc + (Number(curr.amount) || 0), 0);
            };

            const handleSaveCase = async () => {
                let updatedClaims;
                if (editingCase) {
                    updatedClaims = claims.map(c => c.id === editingCase.id ? { ...c, ...newCaseData } : c);
                } else {
                    const newCase = {
                        id: Date.now().toString(),
                        ...newCaseData,
                        records: []
                    };
                    updatedClaims = [...claims, newCase];
                }
                await onUpdate(client.id, { claims: updatedClaims });
                setView('list');
                setEditingCase(null);
            };

            const handleDeleteCase = (caseId) => {
                showConfirm("刪除案件", "確定要刪除此索償案件嗎？\n所有的診症紀錄也會被刪除。", async () => {
                    const updatedClaims = claims.filter(c => c.id !== caseId);
                    await onUpdate(client.id, { claims: updatedClaims });
                    setView('list');
                });
            };

            const handleEditCaseClick = (c) => {
                setEditingCase(c);
                setNewCaseData({ type: c.type, title: c.title, incidentDate: c.incidentDate, status: c.status });
                setView('add_case');
            };

            const handleSaveRecord = async () => {
                if(!activeCase) return;
                
                let updatedRecords;
                if (editingRecordId) {
                    updatedRecords = activeCase.records.map(r => 
                        r.id === editingRecordId ? { ...r, ...newRecordData } : r
                    );
                } else {
                    const newRecord = { id: Date.now().toString(), ...newRecordData };
                    updatedRecords = [...(activeCase.records || []), newRecord];
                }

                const updatedClaims = claims.map(c => {
                    if (c.id === activeCase.id) {
                        return { ...c, records: updatedRecords };
                    }
                    return c;
                });

                await onUpdate(client.id, { claims: updatedClaims });
                setActiveCase(updatedClaims.find(c => c.id === activeCase.id));
                setNewRecordData({ visitDate: '', diagnosis: '', amount: '' });
                setEditingRecordId(null);
            };

            const handleEditRecordClick = (r) => {
                setNewRecordData({ visitDate: r.visitDate, diagnosis: r.diagnosis, amount: r.amount });
                setEditingRecordId(r.id);
            };

            const handleDeleteRecord = (recordId) => {
                showConfirm("刪除紀錄", "確定要刪除這筆診症紀錄嗎？", async () => {
                    const updatedRecords = activeCase.records.filter(r => r.id !== recordId);
                    const updatedClaims = claims.map(c => {
                        if (c.id === activeCase.id) {
                            return { ...c, records: updatedRecords };
                        }
                        return c;
                    });
                    await onUpdate(client.id, { claims: updatedClaims });
                    setActiveCase(updatedClaims.find(c => c.id === activeCase.id));
                    if(editingRecordId === recordId) {
                        setEditingRecordId(null);
                        setNewRecordData({ visitDate: '', diagnosis: '', amount: '' });
                    }
                });
            };

            const handleToggleStatus = async (caseId, currentStatus) => {
                const newStatus = currentStatus === 'processing' ? 'completed' : 'processing';
                const updatedClaims = claims.map(c => c.id === caseId ? { ...c, status: newStatus } : c);
                await onUpdate(client.id, { claims: updatedClaims });
                if(activeCase && activeCase.id === caseId) setActiveCase({...activeCase, status: newStatus});
            };

            return (
                <div className="fixed inset-0 z-50 bg-slate-100 flex flex-col animate-slideIn">
                    {/* Header */}
                    <div className="bg-white px-4 py-3 border-b flex items-center justify-between shadow-sm sticky top-0 z-10">
                        <div className="flex items-center gap-2">
                            <button onClick={() => view === 'list' ? onClose() : setView('list')} className="p-2 -ml-2 rounded-full hover:bg-slate-100">
                                <Icon name={view === 'list' ? 'x' : 'chevronLeft'} />
                            </button>
                            <div>
                                <h2 className="font-bold text-lg text-slate-800">{client.name} - 索償紀錄</h2>
                                <p className="text-xs text-slate-500">管理意外與醫療申報</p>
                            </div>
                        </div>
                        {view === 'list' && <button onClick={() => { setEditingCase(null); setNewCaseData({ type: 'medical', title: '', incidentDate: '', status: 'processing' }); setView('add_case'); }} className="text-xs bg-indigo-600 text-white px-3 py-2 rounded-lg font-bold shadow">+ 新增案件</button>}
                    </div>

                    {/* Content */}
                    <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                        {view === 'list' && (
                            <div className="space-y-3">
                                {claims.length === 0 ? (
                                    <div className="text-center py-12 text-slate-400 bg-white rounded-xl border border-dashed border-slate-300">
                                        <Icon name="clipboard" size={48} className="mx-auto mb-2 opacity-50"/>
                                        <p>暫無索償紀錄</p>
                                    </div>
                                ) : (
                                    claims.map(c => (
                                        <div key={c.id} onClick={() => { setActiveCase(c); setView('case_detail'); setEditingRecordId(null); setNewRecordData({ visitDate: '', diagnosis: '', amount: '' }); }} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm active:scale-98 transition-transform cursor-pointer relative group">
                                            <div className="flex justify-between items-start mb-2">
                                                <span className={`text-[10px] font-bold px-2 py-0.5 rounded border uppercase ${c.type === 'accident' ? 'bg-red-50 text-red-600 border-red-100' : 'bg-blue-50 text-blue-600 border-blue-100'}`}>
                                                    {c.type === 'accident' ? '意外' : '醫療'}
                                                </span>
                                                <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ${c.status === 'processing' ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}`}>
                                                    {c.status === 'processing' ? '處理中' : '已成功'}
                                                </span>
                                            </div>
                                            <h3 className="font-bold text-slate-800 mb-1">{c.title}</h3>
                                            <div className="text-xs text-slate-500 mb-3">發生日期: {c.incidentDate}</div>
                                            <div className="flex justify-between items-end border-t pt-2">
                                                <div className="text-xs text-slate-400">{(c.records||[]).length} 筆紀錄</div>
                                                <div className="text-lg font-bold text-slate-800"><span className="text-xs text-slate-400 font-normal mr-1">總額</span>${calculateTotal(c)}</div>
                                            </div>
                                            {/* Action Buttons */}
                                            <div className="absolute right-2 top-2 flex gap-2">
                                                <button onClick={(e) => { e.stopPropagation(); handleEditCaseClick(c); }} className="p-1.5 bg-slate-100 rounded hover:bg-slate-200 text-slate-500"><Icon name="edit" size={14} /></button>
                                                <button onClick={(e) => { e.stopPropagation(); handleDeleteCase(c.id); }} className="p-1.5 bg-red-50 rounded hover:bg-red-100 text-red-500"><Icon name="trash" size={14} /></button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {view === 'add_case' && (
                            <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm space-y-4">
                                <h3 className="font-bold text-slate-800">{editingCase ? '編輯索償案件' : '開設新索償案件'}</h3>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">類別</label>
                                    <div className="flex bg-slate-100 p-1 rounded-lg">
                                        {['medical', 'accident'].map(t => (
                                            <button key={t} onClick={() => setNewCaseData({...newCaseData, type: t})} className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${newCaseData.type === t ? 'bg-white shadow text-indigo-600' : 'text-slate-400'}`}>
                                                {t === 'medical' ? '醫療' : '意外'}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">標題 (診斷/事故)</label><input type="text" value={newCaseData.title} onChange={e => setNewCaseData({...newCaseData, title: e.target.value})} className="w-full border rounded-lg p-3 bg-slate-50 focus:bg-white" placeholder="例：腸胃炎入院 / 打波扭傷" /></div>
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">{newCaseData.type === 'accident' ? '意外日期' : '生病日期'}</label><input type="date" value={newCaseData.incidentDate} onChange={e => setNewCaseData({...newCaseData, incidentDate: e.target.value})} className="w-full border rounded-lg p-3 bg-slate-50 focus:bg-white" /></div>
                                <button onClick={handleSaveCase} disabled={!newCaseData.title || !newCaseData.incidentDate} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow-lg disabled:opacity-50 mt-4">{editingCase ? '更新案件' : '建立案件'}</button>
                            </div>
                        )}

                        {view === 'case_detail' && activeCase && (
                            <div className="space-y-4">
                                <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                    <div className="flex justify-between items-start mb-2">
                                        <h2 className="text-xl font-bold text-slate-800">{activeCase.title}</h2>
                                        <button onClick={() => handleToggleStatus(activeCase.id, activeCase.status)} className={`text-xs px-2 py-1 rounded border font-bold ${activeCase.status === 'processing' ? 'bg-amber-50 text-amber-600 border-amber-200' : 'bg-emerald-50 text-emerald-600 border-emerald-200'}`}>
                                            {activeCase.status === 'processing' ? '更變為已完成' : '更變為處理中'}
                                        </button>
                                    </div>
                                    <div className="text-xs text-slate-500 flex items-center gap-2 mb-4"><Icon name="calendar" size={12}/> {activeCase.type === 'accident' ? '意外' : '生病'}日期: {activeCase.incidentDate}</div>
                                    <div className="bg-slate-50 p-3 rounded-lg flex justify-between items-center border border-slate-100">
                                        <span className="text-xs text-slate-500 font-bold">總索償金額</span>
                                        <span className="text-xl font-bold text-indigo-600">${calculateTotal(activeCase)}</span>
                                    </div>
                                </div>

                                <div className="space-y-2">
                                    <h3 className="text-xs font-bold text-slate-400 uppercase ml-1">索償紀錄 (流水帳)</h3>
                                    {(activeCase.records || []).map((rec, idx) => (
                                        <div key={idx} className={`p-3 rounded-lg border flex justify-between items-center ${editingRecordId === rec.id ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100'}`}>
                                            <div>
                                                <div className="font-bold text-sm text-slate-700">{rec.diagnosis}</div>
                                                <div className="text-xs text-slate-400">診症日: {rec.visitDate}</div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <div className="font-mono font-bold text-slate-600">${rec.amount}</div>
                                                <div className="flex gap-1">
                                                    <button onClick={() => handleEditRecordClick(rec)} className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded"><Icon name="edit" size={14}/></button>
                                                    <button onClick={() => handleDeleteRecord(rec.id)} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded"><Icon name="trash" size={14}/></button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    
                                    {/* Add/Edit Record Form Inline */}
                                    <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 mt-2">
                                        <div className="flex justify-between items-center mb-2">
                                            <div className="text-xs font-bold text-indigo-600">{editingRecordId ? '編輯紀錄' : '+ 新增紀錄'}</div>
                                            {editingRecordId && <button onClick={() => { setEditingRecordId(null); setNewRecordData({ visitDate: '', diagnosis: '', amount: '' }); }} className="text-[10px] text-slate-400">取消</button>}
                                        </div>
                                        <div className="grid grid-cols-2 gap-2 mb-2">
                                            <input type="date" value={newRecordData.visitDate} onChange={e => setNewRecordData({...newRecordData, visitDate: e.target.value})} className="border rounded p-2 text-xs" />
                                            <input type="number" placeholder="金額" value={newRecordData.amount} onChange={e => setNewRecordData({...newRecordData, amount: e.target.value})} className="border rounded p-2 text-xs" />
                                        </div>
                                        <input type="text" placeholder="診斷 / 項目內容" value={newRecordData.diagnosis} onChange={e => setNewRecordData({...newRecordData, diagnosis: e.target.value})} className="w-full border rounded p-2 text-xs mb-2" />
                                        <button onClick={handleSaveRecord} disabled={!newRecordData.visitDate || !newRecordData.amount} className="w-full bg-indigo-600 text-white py-2 rounded-lg text-xs font-bold shadow disabled:opacity-50">{editingRecordId ? '更新紀錄' : '儲存紀錄'}</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Bottom Navigation ---
        const BottomNav = ({ currentView, setView }) => (
            <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 px-6 py-2 safe-area-bottom flex justify-between items-center z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <button onClick={() => setView('entry')} className={`flex flex-col items-center gap-1 p-2 transition-colors ${currentView === 'entry' ? 'text-indigo-600' : 'text-slate-400'}`}>
                    <Icon name="plus" size={24} />
                    <span className="text-[10px] font-bold">新增</span>
                </button>
                <div className="w-px h-8 bg-slate-100"></div>
                <button onClick={() => setView('database')} className={`flex flex-col items-center gap-1 p-2 transition-colors ${currentView === 'database' ? 'text-indigo-600' : 'text-slate-400'}`}>
                    <Icon name="list" size={24} />
                    <span className="text-[10px] font-bold">列表</span>
                </button>
                <div className="w-px h-8 bg-slate-100"></div>
                <button onClick={() => setView('claims_dashboard')} className={`flex flex-col items-center gap-1 p-2 transition-colors ${currentView === 'claims_dashboard' ? 'text-indigo-600' : 'text-slate-400'}`}>
                    <Icon name="activity" size={24} />
                    <span className="text-[10px] font-bold">索償</span>
                </button>
            </div>
        );

        const SegmentControl = ({ options, value, onChange }) => (
            <div className="flex bg-slate-100 p-1 rounded-lg border border-slate-200">
                {options.map(opt => (
                    <button key={opt.value} type="button" onClick={() => onChange(opt.value)} className={`flex-1 py-2 px-3 text-sm font-medium rounded-md transition-all ${value === opt.value ? 'bg-white text-slate-800 shadow-sm border border-slate-200' : 'text-slate-500 hover:text-slate-700'}`}>{opt.label}</button>
                ))}
            </div>
        );

        // --- 3. 應用程式核心 (Main Content) ---
        const MainContent = () => {
            // Core State
            const [config, setConfig] = useState(null);
            const [user, setUser] = useState(null);
            const [clients, setClients] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentView, setCurrentView] = useState('entry'); 
            const [editingId, setEditingId] = useState(null);
            const fileInputRef = useRef(null);
            const scrollPosRef = useRef(0);
            
            // Claims State
            const [claimsModalData, setClaimsModalData] = useState({ isOpen: false, client: null });
            const [claimsFilter, setClaimsFilter] = useState('processing');
            const [claimsSearch, setClaimsSearch] = useState('');

            // UI State
            const [toasts, setToasts] = useState([]);
            const [modalConfig, setModalConfig] = useState({ isOpen: false });
            const [formStep, setFormStep] = useState(1);
            const [isSubmitReady, setIsSubmitReady] = useState(true);

            const initialFormState = {
                source: '朋友介紹', referrerName: '', name: '', nickname: '', phone: '', 
                residentialArea: '', hobbies: '', occupation: '', income: '', 
                medicalHistory: '', isClient: 'not_yet',
                appointmentDate: '', clientSinceDate: '', remarks: '',
                birthday: '', policyPremium: '', policyCurrency: 'HKD',
                policyDetails: {},
                policies: { criticalIllness: [], vhis: [], saving: [], accident: [], annuity: [], mpf: false },
                claims: []
            };
            const [formData, setFormData] = useState(initialFormState);
            
            // Filter State
            const [searchTerm, setSearchTerm] = useState('');
            const [activeFilters, setActiveFilters] = useState({
                status: 'all',
                source: 'all',
                policies: [] // Empty array means 'all'
            });
            const [sortOrder, setSortOrder] = useState('updated_desc');

            const POLICY_OPTIONS = {
                criticalIllness: { label: '1. 危疾', options: ['危疾應援保(升級版)', '危疾應援保', '危疾全守衛（超卓版)', '危疾晉御保(尊尚版)', '危疾緻尚保', '危疾緻尚保(升級版)', '父母之加添守護選項'] },
                vhis: { label: '2. 醫保', options: ['人仁保醫療保險計劃', '易衛您醫療計劃', '倍衛您醫療計劃', '尊衛您（寰譽版）醫療計劃', '醫家保醫療計劃'] },
                saving: { label: '3. Saving Plan', options: ['盈聚‧天下壽險計劃 – 2年供', '盈聚‧天下壽險計劃 – 5年供', '盈聚優裕壽險計劃 - 5年供', '盈聚環球壽險計劃 - 5年供'] },
                accident: { label: '4. 意外保險', options: ['人身意外保險附約', '全意守護意外保障計劃', '全意衛您意外保障計劃'] },
                annuity: { label: '5. 年金', options: ['盈•歲悅延期年金計劃'] }
            };
            const INCOME_OPTIONS = ['<15K', '15K-30K', '30K-40K', '40K-50K', '50K+'];
            const CURRENCY_OPTIONS = ['HKD', 'USD', 'RMB'];

            // --- Helpers ---
            const addToast = (msg, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, msg, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
            };

            const showConfirm = (title, message, onConfirm, type="danger") => {
                setModalConfig({ isOpen: true, title, message, onConfirm: () => { onConfirm(); setModalConfig({ isOpen: false }); }, type, onCancel: () => setModalConfig({ isOpen: false }) });
            };

            const calculateAge = (birthday) => {
                if (!birthday) return '';
                const birthDate = new Date(birthday);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            };

            // Calculate Counts (Memoized)
            const counts = useMemo(() => {
                const res = {
                    status: { all: clients.length, already: 0, not_yet: 0 },
                    source: { all: clients.length, '朋友介紹': 0, 'Bigboss': 0, '自己朋友': 0, '其他': 0 },
                    policy: { criticalIllness: 0, vhis: 0, saving: 0, annuity: 0, accident: 0, mpf: 0 },
                    totalPolicies: 0
                };

                clients.forEach(c => {
                    // Status
                    if (c.isClient === 'already') res.status.already++;
                    if (c.isClient === 'not_yet') res.status.not_yet++;

                    // Source
                    if (res.source[c.source] !== undefined) {
                        res.source[c.source]++;
                    }

                    // Policies
                    if (c.isClient === 'already') {
                        const p = c.policies || {};
                        res.policy.criticalIllness += (p.criticalIllness || []).length;
                        res.policy.vhis += (p.vhis || []).length;
                        res.policy.saving += (p.saving || []).length;
                        res.policy.annuity += (p.annuity || []).length;
                        res.policy.accident += (p.accident || []).length;
                        if (p.mpf) res.policy.mpf++;
                    }
                });

                res.totalPolicies = Object.values(res.policy).reduce((a, b) => a + b, 0);
                return res;
            }, [clients]);

            // Double-click safety for Wizard Step 3
            useEffect(() => {
                if (formStep === 3) {
                    setIsSubmitReady(false);
                    const timer = setTimeout(() => setIsSubmitReady(true), 800);
                    return () => clearTimeout(timer);
                } else {
                    setIsSubmitReady(true);
                }
            }, [formStep]);

            // Scroll Restoration Logic
            useEffect(() => {
                if (currentView === 'database') {
                    setTimeout(() => {
                        window.scrollTo({ top: scrollPosRef.current, behavior: 'auto' });
                    }, 50);
                } else if (currentView === 'entry') {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }, [currentView]);

            useEffect(() => {
                const savedConfig = localStorage.getItem('felix_db_config');
                if (savedConfig) {
                    try { initializeFirebase(JSON.parse(savedConfig)); } catch (e) { 
                        setLoading(false); setCurrentView('setup'); 
                    }
                } else { 
                    setLoading(false); setCurrentView('setup'); 
                }
            }, []);

            const initializeFirebase = (firebaseConfig) => {
                try {
                    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                    setConfig(firebaseConfig);
                    const auth = firebase.auth();
                    auth.onAuthStateChanged((u) => {
                        if (u) { setUser(u); fetchClients(u); }
                        else { 
                            auth.signInAnonymously().catch(e => {
                                addToast("登入失敗: " + e.message, 'error');
                                setLoading(false);
                            }); 
                        }
                    });
                    if (currentView === 'setup') setCurrentView('entry');
                } catch (err) { 
                    addToast("設定無效，請重置", 'error'); 
                    setLoading(false); setCurrentView('setup'); 
                }
            };

            const handleSaveConfig = (str) => {
                try {
                    let clean = str.trim();
                    if (clean.includes('=')) clean = clean.split('=')[1];
                    if (clean.endsWith(';')) clean = clean.slice(0, -1);
                    const parsed = new Function('return ' + clean)();
                    if(!parsed.apiKey) throw new Error("缺少 apiKey");
                    localStorage.setItem('felix_db_config', JSON.stringify(parsed));
                    initializeFirebase(parsed);
                } catch (e) { addToast("設定格式錯誤", 'error'); }
            };

            const fetchClients = (u) => {
                setLoading(true);
                firebase.firestore().collection('felix_clients').doc('shared_data').collection('data')
                    .onSnapshot(snap => {
                        const list = snap.docs.map(d => {
                            const data = d.data() || {};
                            return {
                                id: d.id,
                                ...data,
                                policies: {
                                    criticalIllness: Array.isArray(data.policies?.criticalIllness) ? data.policies.criticalIllness : [],
                                    vhis: Array.isArray(data.policies?.vhis) ? data.policies.vhis : [],
                                    saving: Array.isArray(data.policies?.saving) ? data.policies.saving : [],
                                    accident: Array.isArray(data.policies?.accident) ? data.policies.accident : [],
                                    annuity: Array.isArray(data.policies?.annuity) ? data.policies.annuity : [],
                                    mpf: !!data.policies?.mpf
                                },
                                policyDetails: data.policyDetails || {},
                                claims: Array.isArray(data.claims) ? data.claims : [],
                                birthday: data.birthday || '',
                                clientSinceDate: data.clientSinceDate || data.policyEffectiveDate || '',
                                createdAt: data.createdAt || { toDate: () => new Date() },
                                updatedAt: data.updatedAt || { toDate: () => new Date() }
                            };
                        });
                        setClients(list);
                        setLoading(false);
                    }, err => { 
                        addToast("資料同步錯誤", 'error'); 
                        setLoading(false); 
                    });
            };

            const handleUpdateClient = async (clientId, updateData) => {
                try {
                    await firebase.firestore().collection('felix_clients').doc('shared_data').collection('data').doc(clientId).update({
                        ...updateData,
                        updatedAt: new Date()
                    });
                    addToast("資料已更新");
                } catch(e) {
                    addToast("更新失敗: " + e.message, 'error');
                }
            };

            const handleInputChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });
            
            const handlePolicyDetailChange = (policyName, field, value) => {
                setFormData(prev => {
                    const currentDetails = prev.policyDetails || {};
                    const policySpecific = currentDetails[policyName] || { premium: '', currency: 'HKD', policyNo: '' };
                    return { ...prev, policyDetails: { ...currentDetails, [policyName]: { ...policySpecific, [field]: value } } };
                });
            };

            const handlePolicyArrayChange = (cat, opt) => {
                setFormData(prev => {
                    const currentArr = Array.isArray(prev.policies[cat]) ? prev.policies[cat] : [];
                    let newArr = currentArr.includes(opt) ? currentArr.filter(i=>i!==opt) : [...currentArr, opt];
                    if (cat === 'criticalIllness') {
                        if (opt === '危疾應援保(升級版)' && newArr.includes('危疾應援保(升級版)')) newArr = newArr.filter(i => i !== '危疾應援保');
                        if (opt === '危疾緻尚保(升級版)' && newArr.includes('危疾緻尚保(升級版)')) newArr = newArr.filter(i => i !== '危疾緻尚保');
                    }
                    return { ...prev, policies: { ...prev.policies, [cat]: newArr } };
                });
            };

            const handlePolicyBoolChange = (cat) => setFormData(prev => ({ ...prev, policies: { ...prev.policies, [cat]: !prev.policies[cat] } }));

            const getSourceStyle = (source) => {
                switch(source) {
                    case '朋友介紹': return 'bg-blue-100 text-blue-700 border-blue-200';
                    case 'Bigboss': return 'bg-purple-100 text-purple-700 border-purple-200';
                    case '自己朋友': return 'bg-amber-100 text-amber-700 border-amber-200';
                    default: return 'bg-slate-100 text-slate-600 border-slate-200';
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user) return;
                // Safety check: Prevent submission if not on final step
                if (formStep < 3) return;

                const db = firebase.firestore().collection('felix_clients').doc('shared_data').collection('data');
                let data = { ...formData };
                // Keep referrerName if source is '朋友介紹' or '其他', otherwise clear it
                if (data.source !== '朋友介紹' && data.source !== '其他') data.referrerName = '';
                
                if (data.isClient === 'not_yet') { data.policies = initialFormState.policies; data.clientSinceDate = ''; data.policyDetails = {}; }
                else { data.appointmentDate = ''; }

                try {
                    const now = new Date();
                    if (editingId) {
                        await db.doc(editingId).update({ ...data, updatedAt: now });
                        addToast("資料已更新");
                    } else {
                        const cleanPhone = String(data.phone).replace(/\D/g, '');
                        const duplicate = clients.find(c => c.name === data.name && String(c.phone).replace(/\D/g, '') === cleanPhone);
                        if (duplicate) {
                            showConfirm("偵測到重複客戶", `${data.name} 已經存在，是否覆蓋資料？`, async () => {
                                await db.doc(duplicate.id).update({ ...data, updatedAt: now });
                                addToast("已合併更新資料");
                                handleCancelEdit();
                                setCurrentView('database'); // Auto return to list
                            }, "info");
                            return;
                        } else {
                            await db.add({ ...data, createdAt: now, updatedAt: now });
                            addToast("成功新增客戶");
                        }
                    }
                    handleCancelEdit();
                    setCurrentView('database'); // Auto return to list
                } catch (err) { addToast("儲存失敗: " + err.message, 'error'); }
            };

            const handleDelete = async (id) => {
                showConfirm("刪除確認", "確定要刪除這位客戶的資料嗎？\n此動作無法復原。", async () => {
                    try {
                        await firebase.firestore().collection('felix_clients').doc('shared_data').collection('data').doc(id).delete();
                        if(editingId === id) handleCancelEdit();
                        addToast("已刪除資料");
                    } catch(e) { addToast("刪除失敗", 'error'); }
                });
            };

            const handleEdit = (c) => {
                // Save current scroll position before switching view
                scrollPosRef.current = window.scrollY;
                
                setCurrentView('entry');
                setFormStep(1); 
                const dateVal = c.clientSinceDate || c.policyEffectiveDate || '';
                const safePolicies = JSON.parse(JSON.stringify(c.policies));
                const safeDetails = JSON.parse(JSON.stringify(c.policyDetails));
                const safeClaims = c.claims ? JSON.parse(JSON.stringify(c.claims)) : [];
                const safeData = { ...initialFormState, ...c, policies: safePolicies, clientSinceDate: dateVal, policyDetails: safeDetails, claims: safeClaims };
                setFormData(safeData);
                setEditingId(c.id);
            };
            
            const handleCancelEdit = () => { 
                setFormData(initialFormState); 
                setEditingId(null); 
                setFormStep(1); 
            };
            
            const returnToDatabase = () => {
                handleCancelEdit();
                setCurrentView('database');
            };

            const formatDate = (ts) => {
                if (!ts) return '-';
                try {
                    const d = ts.toDate ? ts.toDate() : (ts instanceof Date ? ts : new Date(ts));
                    if (isNaN(d.getTime())) return '-';
                    return d.toLocaleString('zh-HK', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
                } catch(e) { return '-'; }
            };

            const getSafeDate = (val) => {
                if (!val) return new Date(0);
                if (val.toDate) return val.toDate(); // Firebase Timestamp
                if (val instanceof Date) return val; // JS Date
                return new Date(val); // String or number
            };

            // --- Import/Export Helpers ---
            const parseExcelDate = (value) => {
                if (!value) return '';
                if (typeof value === 'number') {
                    const date = new Date(Math.round((value - 25569) * 86400 * 1000));
                    date.setMinutes(date.getMinutes() + date.getTimezoneOffset()); 
                    return date.toISOString().split('T')[0];
                }
                const d = new Date(value);
                return !isNaN(d.getTime()) ? d.toISOString().split('T')[0] : '';
            };

            const findValue = (row, possibleKeys) => {
                const keys = Object.keys(row);
                for (let pk of possibleKeys) {
                    const foundKey = keys.find(k => k.toLowerCase().includes(pk.toLowerCase()));
                    if (foundKey) return row[foundKey];
                }
                return '';
            };

            const exportToCSV = () => {
                let csv = "姓名,暱稱,電話,生日,來源,介紹人,地區,興趣,職業,收入,狀態,預約日期,成為客戶日期,保單明細,病歷,備註,索償次數,建立時間,最後修改\n";
                filteredClients.forEach(c => {
                    let polStr = "";
                    if (c.isClient === 'already') {
                        const p = c.policies || {};
                        const d = c.policyDetails || {};
                        const arr = [...(p.criticalIllness || []), ...(p.vhis || []), ...(p.saving || []), ...(p.accident || []), ...(p.annuity || []), p.mpf ? "MPF" : ""];
                        polStr = arr.filter(Boolean).map(name => {
                            const detail = d[name];
                            if (detail && (detail.premium || detail.policyNo)) return `${name}(${detail.currency}$${detail.premium || '-'} #${detail.policyNo || '-'})`;
                            return name;
                        }).join(" / ");
                    }
                    const createdStr = formatDate(c.createdAt);
                    const updatedStr = formatDate(c.updatedAt);
                    const sinceDate = c.clientSinceDate || "-";
                    const claimsCount = (c.claims || []).length;
                    const row = [c.name, c.nickname||"-", `'${c.phone}`, c.birthday||"-", c.source, c.referrerName||"-", c.residentialArea||"-", c.hobbies?`"${c.hobbies}"`:"-", c.occupation||"-", c.income||"-", c.isClient==='already'?"已成交":"潛在", c.appointmentDate||"-", sinceDate, `"${polStr}"`, c.medicalHistory?`"${c.medicalHistory}"`:"-", c.remarks?`"${c.remarks}"`:"-", claimsCount, createdStr, updatedStr];
                    csv += row.join(",") + "\n";
                });
                const link = document.createElement("a");
                link.href = encodeURI("data:text/csv;charset=utf-8,\uFEFF"+csv);
                link.download = `Felix_DB_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
                addToast("Excel 下載已開始");
            };

            const handleImportClick = () => fileInputRef.current.click();

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        setLoading(true);
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: true });
                        const db = firebase.firestore().collection('felix_clients').doc('shared_data').collection('data');
                        
                        let addedCount = 0; 
                        const batchOperations = new Map();
                        
                        clients.forEach(c => {
                             const key = `${c.name}_${String(c.phone).replace(/\D/g, '')}`;
                             batchOperations.set(key, { ...c, existingId: c.id });
                        });

                        for (const row of rawData) {
                            const name = findValue(row, ['name', '姓名', '客戶']) || '';
                            let phone = findValue(row, ['phone', 'tel', 'mobile', '電話']) || '';
                            phone = String(phone).replace(/['\s-]/g, ''); 
                            const cleanPhone = phone.replace(/\D/g, '');
                            if (!name || !cleanPhone) continue;

                            const uniqueKey = `${name}_${cleanPhone}`;
                            const nickname = findValue(row, ['nickname', 'nick', '花名', '暱稱']) || '';
                            const birthday = parseExcelDate(findValue(row, ['birthday', 'dob', 'birth', '生日']));
                            const policyStr = String(findValue(row, ['保障名稱', '保障', '保單', 'policy', 'plan']) || '');
                            const remarksStr = findValue(row, ['remarks', 'note', '備註']) || '';
                            const occupation = findValue(row, ['job', 'occupation', '職業']) || '';
                            const income = findValue(row, ['income', 'salary', '收入']) || '';
                            const joinDate = parseExcelDate(findValue(row, ['生效', '成為客戶', 'effective', 'join']));
                            const premium = findValue(row, ['每期保費', '保費', 'premium']) || '';
                            const currency = findValue(row, ['貨幣', 'currency']) || 'HKD';
                            const policyNo = findValue(row, ['保單編號', '保單號碼', 'policy no', 'policy number']);

                            let clientData = {
                                name, phone, nickname, birthday, occupation, income,
                                isClient: 'already',
                                policies: { criticalIllness: [], vhis: [], saving: [], accident: [], annuity: [], mpf: false },
                                policyDetails: {},
                                remarks: remarksStr,
                                clientSinceDate: joinDate || '',
                                claims: [],
                                existingId: null
                            };
                            
                            let isPolicyNoAssigned = false;

                            if (policyStr) {
                                if (policyStr.toUpperCase().includes('MPF')) clientData.policies.mpf = true;
                                const categories = ['criticalIllness', 'vhis', 'saving', 'accident', 'annuity'];
                                categories.forEach(cat => {
                                    POLICY_OPTIONS[cat].options.forEach(option => {
                                        if (policyStr.includes(option)) {
                                            clientData.policies[cat].push(option);
                                            if (premium || policyNo) {
                                                clientData.policyDetails[option] = { premium: premium, currency: currency, policyNo: policyNo };
                                                if (policyNo) isPolicyNoAssigned = true;
                                            }
                                        }
                                    });
                                });
                                // Logic
                                if (clientData.policies.criticalIllness.includes('危疾應援保(升級版)')) clientData.policies.criticalIllness = clientData.policies.criticalIllness.filter(p => p !== '危疾應援保');
                                if (clientData.policies.criticalIllness.includes('危疾緻尚保(升級版)')) clientData.policies.criticalIllness = clientData.policies.criticalIllness.filter(p => p !== '危疾緻尚保');

                                const hasMatch = categories.some(cat => clientData.policies[cat].length > 0) || clientData.policies.mpf;
                                if (!hasMatch && policyStr.length > 1) {
                                    clientData.remarks = clientData.remarks ? `${clientData.remarks} [保單: ${policyStr}]` : `[保單: ${policyStr}]`;
                                }
                            }
                            
                            if (policyNo && !isPolicyNoAssigned) {
                                const noStr = `[保單號: ${policyNo}]`;
                                clientData.remarks = clientData.remarks ? `${clientData.remarks} ${noStr}` : noStr;
                            }

                            const prevData = batchOperations.get(uniqueKey);
                            if (prevData) {
                                // Merge logic simplified for brevity
                                if (!prevData.birthday && clientData.birthday) prevData.birthday = clientData.birthday;
                                ['criticalIllness', 'vhis', 'saving', 'accident', 'annuity'].forEach(cat => {
                                    prevData.policies[cat] = [...new Set([...(prevData.policies[cat]||[]), ...clientData.policies[cat]])];
                                });
                                prevData.policies.mpf = prevData.policies.mpf || clientData.policies.mpf;
                                prevData.policyDetails = { ...prevData.policyDetails, ...clientData.policyDetails };
                                batchOperations.set(uniqueKey, prevData);
                            } else {
                                batchOperations.set(uniqueKey, clientData);
                            }
                        }

                        const now = new Date();
                        for (const [key, data] of batchOperations) {
                            const { existingId, ...payload } = data;
                            payload.updatedAt = now;
                            if (existingId) {
                                await db.doc(existingId).update(payload);
                            } else {
                                payload.createdAt = now;
                                await db.add(payload);
                                addedCount++;
                            }
                        }
                        addToast(`匯入完成！處理 ${batchOperations.size} 筆資料`);
                    } catch (err) { addToast("匯入錯誤: " + err.message, 'error'); } finally { setLoading(false); e.target.value = ''; }
                };
                reader.readAsArrayBuffer(file);
            };

            const getUpcomingBirthdays = (list) => {
                if (!list || list.length === 0) return [];
                const today = new Date(); today.setHours(0,0,0,0);
                return list.filter(c => {
                    if(!c.birthday) return false;
                    const bDate = new Date(c.birthday);
                    const thisYearBday = new Date(today.getFullYear(), bDate.getMonth(), bDate.getDate());
                    if (thisYearBday < today) thisYearBday.setFullYear(today.getFullYear() + 1);
                    const diffTime = Math.abs(thisYearBday - today);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    return diffDays >= 0 && diffDays <= 7;
                }).map(c => {
                    const bDate = new Date(c.birthday);
                    const thisYearBday = new Date(today.getFullYear(), bDate.getMonth(), bDate.getDate());
                    if (thisYearBday < today) thisYearBday.setFullYear(today.getFullYear() + 1);
                    const diffDays = Math.ceil((thisYearBday - today) / (1000 * 60 * 60 * 24));
                    return { ...c, displayDate: `${bDate.getMonth() + 1}月${bDate.getDate()}日`, daysUntil: diffDays };
                });
            };

            const togglePolicyFilter = (policy) => {
                setActiveFilters(prev => {
                    if (policy === 'all') return { ...prev, policies: [] };
                    const current = prev.policies || [];
                    const newPolicies = current.includes(policy) 
                        ? current.filter(p => p !== policy)
                        : [...current, policy];
                    return { ...prev, policies: newPolicies };
                });
            };

            // --- Filter & Sort Logic ---
            const filteredClients = clients.filter(c => {
                const s = searchTerm.toLowerCase();
                const mSearch = (c.name||'').toLowerCase().includes(s) || (c.phone||'').includes(s) || (c.nickname||'').toLowerCase().includes(s) || (c.occupation||'').includes(s);
                
                const mStatus = activeFilters.status === 'all' || c.isClient === activeFilters.status;
                const mSource = activeFilters.source === 'all' || c.source === activeFilters.source;
                
                let mPolicy = true;
                const selectedPolicies = activeFilters.policies || [];
                if(selectedPolicies.length > 0) {
                    if(c.isClient !== 'already') {
                        mPolicy = false;
                    } else {
                        const p = c.policies || {};
                        mPolicy = selectedPolicies.every(type => {
                            if(type === 'criticalIllness') return p.criticalIllness?.length > 0;
                            if(type === 'vhis') return p.vhis?.length > 0;
                            if(type === 'saving') return p.saving?.length > 0;
                            if(type === 'annuity') return p.annuity?.length > 0;
                            if(type === 'accident') return p.accident?.length > 0;
                            if(type === 'mpf') return p.mpf === true;
                            return false;
                        });
                    }
                }
                return mSearch && mStatus && mSource && mPolicy;
            }).sort((a, b) => {
                if (sortOrder === 'since_desc') {
                    const da = a.clientSinceDate || ''; const db = b.clientSinceDate || '';
                    return da < db ? 1 : da > db ? -1 : 0;
                }
                if (sortOrder === 'since_asc') {
                    const da = a.clientSinceDate || ''; const db = b.clientSinceDate || '';
                    if (!da) return 1; if (!db) return -1;
                    return da > db ? 1 : da < db ? -1 : 0;
                }
                const da = getSafeDate(a.updatedAt);
                const db = getSafeDate(b.updatedAt);
                return db - da;
            });

            const upcomingBirthdays = getUpcomingBirthdays(clients);

            const allClaims = clients.flatMap(client => 
                (client.claims || []).map(claim => ({ ...claim, clientName: client.name, clientId: client.id, recordsCount: (claim.records || []).length, totalAmount: (claim.records || []).reduce((acc, curr) => acc + (Number(curr.amount) || 0), 0) }))
            ).sort((a, b) => new Date(b.incidentDate) - new Date(a.incidentDate));

            const filteredDashboardClaims = allClaims.filter(c => {
                const matchesSearch = c.clientName.toLowerCase().includes(claimsSearch.toLowerCase()) || c.title.toLowerCase().includes(claimsSearch.toLowerCase());
                const matchesStatus = c.status === claimsFilter;
                return matchesSearch && matchesStatus;
            });

            const handleQuickStatusToggle = async (e, clientId, claimId, currentStatus) => {
                e.stopPropagation();
                const client = clients.find(c => c.id === clientId);
                if (!client) return;

                const newStatus = currentStatus === 'processing' ? 'completed' : 'processing';
                const updatedClaims = (client.claims || []).map(c => 
                    c.id === claimId ? { ...c, status: newStatus } : c
                );

                await handleUpdateClient(clientId, { claims: updatedClaims });
                addToast(newStatus === 'completed' ? "案件已標記為完成" : "案件已重開為處理中");
            };

            const renderPolicyInputs = (policyName) => {
                const details = (formData.policyDetails && formData.policyDetails[policyName]) || {};
                return (
                    <div className="policy-detail-box">
                        <input placeholder="每期保費" type="number" value={details.premium || ''} onChange={(e) => handlePolicyDetailChange(policyName, 'premium', e.target.value)} className="w-full border rounded p-1.5 focus:border-indigo-500 outline-none" />
                        <select value={details.currency || 'HKD'} onChange={(e) => handlePolicyDetailChange(policyName, 'currency', e.target.value)} className="w-full border rounded p-1.5 bg-white focus:border-indigo-500 outline-none">
                            {CURRENCY_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                        <input placeholder="保單號碼" value={details.policyNo || ''} onChange={(e) => handlePolicyDetailChange(policyName, 'policyNo', e.target.value)} className="w-full border rounded p-1.5 focus:border-indigo-500 outline-none" />
                    </div>
                );
            };

            const resetSystem = () => {
                showConfirm("系統重置確認", "確定要登出並清除所有本地設定嗎？下次使用需要重新輸入 Firebase 設定。", () => {
                    localStorage.removeItem('felix_db_config');
                    window.location.reload();
                });
            };

            // --- Render Logic ---
            if (currentView === 'setup') {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-900 p-6">
                        <ToastContainer toasts={toasts} removeToast={(id) => setToasts(prev => prev.filter(t => t.id !== id))} />
                        <div className="bg-white p-8 rounded-xl w-full max-w-md shadow-2xl border border-slate-700 animate-slideUp">
                            <h1 className="text-2xl font-bold mb-2 text-slate-800 tracking-tight">Felix DB Setup</h1>
                            <p className="text-sm text-slate-500 mb-6">請輸入 Firebase 設定碼</p>
                            <form onSubmit={e => {e.preventDefault(); handleSaveConfig(e.target.conf.value)}}>
                                <textarea name="conf" rows="8" className="w-full border border-slate-300 p-3 text-xs mb-4 rounded-lg font-mono bg-slate-50 focus:ring-2 focus:ring-slate-500 outline-none" placeholder='{ "apiKey": "...", ... }' required></textarea>
                                <button className="w-full bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-lg font-bold shadow-lg transition-transform active:scale-95">啟動系統</button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <>
                    <ToastContainer toasts={toasts} removeToast={(id) => setToasts(prev => prev.filter(t => t.id !== id))} />
                    <Modal {...modalConfig} />
                    <ClaimsManager 
                        isOpen={claimsModalData.isOpen} 
                        client={claimsModalData.client} 
                        onClose={() => setClaimsModalData({isOpen: false, client: null})}
                        onUpdate={handleUpdateClient}
                        showConfirm={showConfirm}
                    />
                    <BottomNav currentView={currentView} setView={setCurrentView} />

                    <header className="hidden md:flex bg-slate-900 text-white py-4 px-5 sticky top-0 z-50 md:mt-4 md:rounded-xl shadow-lg justify-between items-center backdrop-blur-md bg-opacity-95">
                        <div className="flex items-center gap-3">
                            <div className="p-1.5 bg-slate-800 rounded-lg border border-slate-700"><Icon name="dashboard" className="text-emerald-400" /></div>
                            <div><h1 className="font-bold text-lg tracking-wide leading-none">Felix DB</h1><p className="text-[10px] text-slate-400 uppercase tracking-widest mt-0.5">Professional CRM</p></div>
                        </div>
                        <div className="flex bg-slate-800 p-1 rounded-lg border border-slate-700">
                            <button onClick={()=>setCurrentView('entry')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${currentView==='entry'?'bg-slate-600 text-white shadow-sm':'text-slate-400 hover:text-white'}`}>新增</button>
                            <button onClick={()=>setCurrentView('database')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${currentView==='database'?'bg-slate-600 text-white shadow-sm':'text-slate-400 hover:text-white'}`}>列表</button>
                            <button onClick={()=>setCurrentView('claims_dashboard')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${currentView==='claims_dashboard'?'bg-slate-600 text-white shadow-sm':'text-slate-400 hover:text-white'}`}>索償紀錄</button>
                            <button onClick={resetSystem} className="ml-2 text-slate-400 hover:text-red-400" title="重置系統"><Icon name="reset"/></button>
                        </div>
                    </header>

                    <main className="flex-1 py-6 px-4 md:px-0 pb-24">
                        {currentView === 'entry' && (
                            <form onSubmit={handleSubmit} className="animate-slideIn max-w-2xl mx-auto flex flex-col h-full" onKeyDown={(e) => { if(e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') e.preventDefault(); }}>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold text-slate-800 flex items-center"><span className={`w-2 h-6 mr-3 rounded-full ${editingId ? 'bg-amber-500' : 'bg-slate-800'}`}></span>{editingId ? '編輯客戶' : '新增客戶'}</h2>
                                    {editingId && <button type="button" onClick={returnToDatabase} className="text-xs bg-white border border-slate-300 px-3 py-1.5 rounded shadow-sm hover:bg-slate-50">取消編輯</button>}
                                </div>
                                
                                {/* Wizard Steps */}
                                <div className="flex mb-6 bg-slate-100 p-1 rounded-full">
                                    {[1, 2, 3].map(s => (
                                        <div key={s} onClick={() => setFormStep(s)} className={`flex-1 text-center py-1 text-xs font-bold rounded-full transition-all cursor-pointer ${formStep === s ? 'bg-white shadow text-indigo-600' : 'text-slate-400'}`}>
                                            {s === 1 ? '基本' : s === 2 ? '保單' : '備註'}
                                        </div>
                                    ))}
                                </div>

                                <div className="flex-1">
                                    {formStep === 1 && (
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 animate-slideIn">
                                            <div className="section-title">基本資訊</div>
                                            <div className="grid grid-cols-1 gap-5 mb-5">
                                                <div><label className="block text-sm font-semibold text-slate-700 mb-1.5">客戶姓名</label><input name="name" value={formData.name} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-3 bg-slate-50 focus:bg-white focus:border-indigo-500 transition-colors" placeholder="輸入姓名" required /></div>
                                                <div><label className="block text-sm font-semibold text-slate-700 mb-1.5">電話號碼</label><input name="phone" type="tel" value={formData.phone} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-3 bg-slate-50 focus:bg-white" placeholder="手機號碼" required /></div>
                                                <div><label className="block text-sm font-semibold text-slate-700 mb-1.5">暱稱</label><input name="nickname" value={formData.nickname} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-3 bg-slate-50 focus:bg-white" /></div>
                                                <div><label className="block text-sm font-semibold text-slate-700 mb-1.5">生日</label><input type="date" name="birthday" value={formData.birthday} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-3 bg-slate-50 focus:bg-white" /></div>
                                            </div>
                                            <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">來源</label>
                                                <select name="source" value={formData.source} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-3 bg-white mb-3"><option>朋友介紹</option><option>Bigboss</option><option>自己朋友</option><option>其他</option></select>
                                                {(formData.source === '朋友介紹' || formData.source === '其他') && (<input name="referrerName" value={formData.referrerName} onChange={handleInputChange} className="w-full border border-indigo-200 rounded-lg p-3 bg-indigo-50 focus:bg-white text-indigo-900" placeholder={formData.source === '朋友介紹' ? "介紹人姓名" : "請註明來源"} />)}
                                            </div>
                                        </div>
                                    )}

                                    {formStep === 2 && (
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 animate-slideIn">
                                            <div className="section-title">狀態與保單</div>
                                            <div className="mb-6"><SegmentControl options={[{label: '潛在客戶', value: 'not_yet'}, {label: '已成交', value: 'already'}]} value={formData.isClient} onChange={(val) => setFormData({...formData, isClient: val})} /></div>
                                            
                                            {formData.isClient === 'already' ? (
                                                <div className="bg-slate-50 border border-slate-200 rounded-xl p-4 animate-slideIn space-y-4">
                                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">成交日期</label><input type="date" name="clientSinceDate" value={formData.clientSinceDate} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-2.5 bg-white" /></div>
                                                    {['criticalIllness','vhis','saving','accident','annuity'].map(k => (
                                                        <div key={k} className="bg-white p-3 rounded-lg border border-slate-100">
                                                            <p className="text-xs font-bold text-slate-800 mb-2">{POLICY_OPTIONS[k].label}</p>
                                                            <div className="space-y-2">
                                                                {POLICY_OPTIONS[k].options.map(o=>(
                                                                    <div key={o}>
                                                                        <label className={`flex items-start p-2 rounded border cursor-pointer transition-all ${formData.policies[k].includes(o) ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-slate-100'}`}>
                                                                            <input type="checkbox" checked={formData.policies[k].includes(o)} onChange={()=>handlePolicyArrayChange(k,o)} className="mt-1 hidden"/>
                                                                            <div className={`w-4 h-4 min-w-[1rem] rounded border flex items-center justify-center mr-2 mt-0.5 ${formData.policies[k].includes(o) ? 'bg-indigo-600 border-indigo-600' : 'border-slate-300'}`}>{formData.policies[k].includes(o) && <Icon name="check" size={12} className="text-white"/>}</div>
                                                                            <span className="text-sm font-medium leading-tight">{o}</span>
                                                                        </label>
                                                                        {formData.policies[k].includes(o) && renderPolicyInputs(o)}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}
                                                    <div className="bg-white p-3 rounded-lg border border-slate-100">
                                                        <label className={`flex items-center justify-center p-3 rounded border cursor-pointer transition-all ${formData.policies.mpf ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-slate-50 border-slate-200'}`}>
                                                            <input type="checkbox" checked={formData.policies.mpf} onChange={()=>handlePolicyBoolChange('mpf')} className="hidden"/>
                                                            <span className="text-sm font-bold">MPF 強積金</span>
                                                        </label>
                                                        {formData.policies.mpf && renderPolicyInputs('MPF')}
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="animate-slideIn"><label className="block text-sm font-bold text-amber-600 mb-1.5">預約見面日期</label><input type="date" name="appointmentDate" value={formData.appointmentDate} onChange={handleInputChange} className="w-full border border-amber-200 rounded-lg p-2.5 bg-amber-50 focus:bg-white text-amber-900" /></div>
                                            )}
                                        </div>
                                    )}

                                    {formStep === 3 && (
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 animate-slideIn">
                                            <div className="section-title">詳細背景</div>
                                            <div className="grid grid-cols-2 gap-5 mb-5">
                                                <div><label className="block text-sm font-semibold text-slate-700 mb-1.5">職業</label><input name="occupation" value={formData.occupation} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:bg-white" /></div>
                                                <div><label className="block text-sm font-semibold text-slate-700 mb-1.5">收入</label><select name="income" value={formData.income} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:bg-white"><option value="">選擇...</option>{INCOME_OPTIONS.map(o=><option key={o} value={o}>{o}</option>)}</select></div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-5 mb-5">
                                                <div><label className="block text-sm font-semibold text-slate-700 mb-1.5">地區</label><input name="residentialArea" value={formData.residentialArea} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:bg-white" /></div>
                                                <div><label className="block text-sm font-semibold text-slate-700 mb-1.5">興趣</label><input name="hobbies" value={formData.hobbies} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:bg-white" /></div>
                                            </div>
                                            <div className="mb-5"><label className="block text-sm font-semibold text-slate-700 mb-1.5">病歷資料</label><textarea name="medicalHistory" value={formData.medicalHistory} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-3 bg-slate-50 focus:bg-white h-24 text-sm" placeholder="既往症或體況..."></textarea></div>
                                            <div><label className="block text-sm font-semibold text-slate-700 mb-1.5">備註事項</label><textarea name="remarks" value={formData.remarks} onChange={handleInputChange} className="w-full border border-slate-300 rounded-lg p-3 bg-slate-50 focus:bg-white h-24 text-sm" placeholder="其他記事..."></textarea></div>
                                        </div>
                                    )}
                                </div>

                                {/* Wizard Buttons */}
                                <div className="mt-6 flex gap-3">
                                    {formStep > 1 && <button type="button" onClick={() => setFormStep(s=>s-1)} className="flex-1 py-3.5 bg-slate-200 text-slate-700 font-bold rounded-xl active:scale-95 transition-transform">上一步</button>}
                                    {formStep < 3 ? (
                                        <button type="button" onClick={() => setFormStep(s=>s+1)} className="flex-1 py-3.5 bg-slate-800 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">下一步</button>
                                    ) : (
                                        <button type="submit" disabled={!isSubmitReady} className={`flex-1 py-3.5 text-white font-bold rounded-xl shadow-lg flex items-center justify-center transition-all ${editingId ? 'bg-amber-500' : 'bg-slate-800'} ${!isSubmitReady ? 'opacity-50 cursor-not-allowed scale-95' : 'active:scale-95'}`}><Icon name="save" className="mr-2"/> {editingId ? '更新資料' : '完成儲存'}</button>
                                    )}
                                </div>
                            </form>
                        )}

                        {currentView === 'database' && (
                            <div className="space-y-6 max-w-4xl mx-auto">
                                {/* Search & Filter Chips */}
                                <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 space-y-4 sticky top-4 z-30 md:static">
                                    <div className="relative"><div className="absolute left-3 top-3 text-slate-400"><Icon name="search"/></div><input placeholder="搜尋姓名、暱稱、電話..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} className="w-full border border-slate-200 rounded-lg pl-10 p-2.5 bg-slate-50 focus:bg-white outline-none" /></div>
                                    
                                    {/* Filter Chips Scroll View */}
                                    <div className="flex gap-2 overflow-x-auto custom-scrollbar pb-2">
                                        {/* Status Filters */}
                                        {[{l:'全部狀態',v:'all'},{l:'已成交',v:'already'},{l:'潛在',v:'not_yet'}].map(o => (
                                            <button key={o.v} onClick={()=>setActiveFilters({...activeFilters, status: o.v})} className={`whitespace-nowrap px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${activeFilters.status === o.v ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200'}`}>{o.l} <span className="ml-1 text-[10px] opacity-80">({counts.status[o.v]})</span></button>
                                        ))}
                                        <div className="w-px bg-slate-200 mx-1"></div>
                                        {/* Source Filters */}
                                        {[{l:'所有來源',v:'all'}, {l:'朋友介紹',v:'朋友介紹'}, {l:'Bigboss',v:'Bigboss'}, {l:'自己朋友',v:'自己朋友'}, {l:'其他',v:'其他'}].map(o => (
                                            <button key={o.v} onClick={()=>setActiveFilters({...activeFilters, source: o.v})} className={`whitespace-nowrap px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${activeFilters.source === o.v ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200'}`}>{o.l} <span className="ml-1 text-[10px] opacity-80">({counts.source[o.v]})</span></button>
                                        ))}
                                        <div className="w-px bg-slate-200 mx-1"></div>
                                        {/* Policy Filters (Multi-select) */}
                                        <button 
                                            onClick={()=>togglePolicyFilter('all')} 
                                            className={`whitespace-nowrap px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${activeFilters.policies.length === 0 ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-indigo-600 border-indigo-100'}`}
                                        >
                                            所有保單 <span className="ml-1 text-[10px] opacity-80">({counts.totalPolicies})</span>
                                        </button>
                                        {[{l:'危疾',v:'criticalIllness'},{l:'醫保',v:'vhis'},{l:'Saving',v:'saving'},{l:'年金',v:'annuity'},{l:'意外',v:'accident'},{l:'MPF',v:'mpf'}].map(o => (
                                            <button 
                                                key={o.v} 
                                                onClick={()=>togglePolicyFilter(o.v)} 
                                                className={`whitespace-nowrap px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${activeFilters.policies.includes(o.v) ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-indigo-600 border-indigo-100'}`}
                                            >
                                                {o.l} <span className="ml-1 text-[10px] opacity-80">({counts.policy[o.v]})</span>
                                            </button>
                                        ))}
                                    </div>

                                    <div className="flex flex-wrap gap-2 justify-between items-center pt-2 border-t border-slate-100">
                                        <div className="flex items-center gap-2">
                                            <div className="text-xs text-slate-400 font-medium whitespace-nowrap">排序:</div>
                                            <select 
                                                value={sortOrder} 
                                                onChange={(e) => setSortOrder(e.target.value)}
                                                className="text-xs border border-slate-200 rounded p-1.5 bg-slate-50 outline-none text-slate-600 font-medium"
                                            >
                                                <option value="updated_desc">🔄 最近更新</option>
                                                <option value="since_desc">⬇️ 客人: 新至舊</option>
                                                <option value="since_asc">⬆️ 客人: 舊至新</option>
                                            </select>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={exportToCSV} className="p-2 text-slate-500 hover:text-slate-800 bg-slate-50 rounded hover:bg-slate-100"><Icon name="download" size={16}/></button>
                                            <button onClick={handleImportClick} className="p-2 text-slate-500 hover:text-emerald-600 bg-slate-50 rounded hover:bg-emerald-50"><Icon name="upload" size={16}/></button>
                                            <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".xlsx, .xls" className="hidden" />
                                        </div>
                                    </div>
                                </div>

                                {/* Birthday Reminder */}
                                {upcomingBirthdays.length > 0 && (
                                    <div className="bg-white rounded-xl shadow-sm border border-pink-100 overflow-hidden animate-slideIn">
                                        <div className="bg-gradient-to-r from-pink-50 to-white px-4 py-3 border-b border-pink-100 flex items-center"><Icon name="gift" className="text-pink-500 mr-2"/><h3 className="font-bold text-slate-800 text-sm">近期生日 (7天內)</h3></div>
                                        <div className="p-4 flex gap-3 overflow-x-auto custom-scrollbar">{upcomingBirthdays.map(c => {
                                            const cleanPhone = c.phone.replace(/\D/g, '');
                                            const waLink = `https://wa.me/852${cleanPhone}`;
                                            return (
                                                <div key={c.id} className="min-w-[160px] bg-pink-50/50 border border-pink-100 rounded-lg p-3 flex flex-col relative group">
                                                    <div className="font-bold text-slate-700">{c.name}</div>
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <div className="text-xs text-pink-500 font-bold flex items-center"><Icon name="cake" size={12} className="mr-1"/>{c.displayDate}</div>
                                                        <div className={`text-[10px] font-bold px-1.5 py-0.5 rounded-full ${c.daysUntil === 0 ? 'bg-red-500 text-white' : 'bg-pink-100 text-pink-600'}`}>{c.daysUntil === 0 ? '今日!' : `${c.daysUntil}天`}</div>
                                                    </div>
                                                    <div className="text-[10px] text-slate-400 font-mono mb-2">{c.phone}</div>
                                                    <a href={waLink} target="_blank" className="mt-auto bg-[#25D366] hover:bg-[#128C7E] text-white text-xs font-bold py-1.5 px-2 rounded flex items-center justify-center shadow-sm transition-colors no-underline">
                                                        <Icon name="message" size={14} className="mr-1"/> WhatsApp
                                                    </a>
                                                </div>
                                            );
                                        })}</div>
                                    </div>
                                )}

                                {/* List */}
                                <div className="space-y-4">
                                    {loading ? (
                                        <>
                                            <SkeletonCard />
                                            <SkeletonCard />
                                            <SkeletonCard />
                                        </>
                                    ) : filteredClients.length === 0 ? (
                                        <div className="text-center text-slate-400 py-12 bg-white rounded-xl border border-dashed border-slate-300">沒有符合的資料</div>
                                    ) : filteredClients.map(c => (
                                        <div key={c.id} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition-shadow animate-fadeIn">
                                            <div className="p-4 border-b border-slate-100 flex justify-between items-start bg-gradient-to-r from-slate-50 to-white">
                                                <div>
                                                    <div className="flex flex-wrap items-center gap-2 mb-1">
                                                        {c.nickname ? (
                                                            <div className="flex items-baseline"><h3 className="font-bold text-lg text-slate-800 mr-2">{c.nickname}</h3><span className="text-sm text-slate-500 font-normal">({c.name})</span></div>
                                                        ) : (
                                                            <h3 className="font-bold text-lg text-slate-800">{c.name}</h3>
                                                        )}
                                                        
                                                        {c.birthday && (
                                                            <div className="flex items-center text-[10px] text-slate-400 bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">
                                                                <span className="mr-1">🎂</span>
                                                                <span>{c.birthday}</span>
                                                                <span className="ml-1 font-bold text-slate-500">({calculateAge(c.birthday)}歲)</span>
                                                            </div>
                                                        )}

                                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full border uppercase tracking-wider ${c.isClient==='already' ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-slate-100 text-slate-600 border-slate-200'}`}>{c.isClient==='already' ? '已成交' : '潛在'}</span>
                                                    </div>
                                                    <div className="text-sm text-slate-500 font-mono flex items-center mt-1">
                                                        <Icon name="phone" size={14} className="mr-1.5 text-slate-400" />
                                                        <a href={`tel:${c.phone}`} className="hover:underline">{c.phone}</a>
                                                    </div>
                                                </div>
                                                <div className="flex flex-col gap-2 items-end">
                                                    <div className={`text-[10px] font-bold px-2 py-1 rounded border flex items-center ${getSourceStyle(c.source)}`}>
                                                        <Icon name="user" size={10} className="mr-1"/> {c.source}
                                                    </div>
                                                    {c.isClient === 'already' && (
                                                        <button onClick={(e) => { e.stopPropagation(); setClaimsModalData({isOpen: true, client: c}); }} className="flex items-center text-[10px] bg-purple-100 text-purple-700 px-2 py-1 rounded-full font-bold hover:bg-purple-200 transition-colors">
                                                            <Icon name="activity" size={12} className="mr-1"/> 索償紀錄
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* Content */}
                                            <div className="p-4 space-y-3">
                                                {c.isClient === 'already' && (
                                                    <div className="flex flex-wrap gap-1 mb-2">
                                                         {[...(c.policies.criticalIllness||[]), ...(c.policies.vhis||[]), ...(c.policies.saving||[]), ...(c.policies.accident||[]), ...(c.policies.annuity||[]), c.policies.mpf&&"MPF"].filter(Boolean).map(p => {
                                                            const details = (c.policyDetails && c.policyDetails[p]) || {};
                                                            return (
                                                                <span key={p} className="text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded border border-indigo-100 font-medium flex items-center">
                                                                    {p} 
                                                                    {details.policyNo && <span className="ml-1 text-indigo-500">#{details.policyNo}</span>}
                                                                    {details.premium && <span className="opacity-75 ml-1">(${details.premium})</span>}
                                                                </span>
                                                            );
                                                         })}
                                                    </div>
                                                )}

                                                <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-slate-600">
                                                    <div className="flex items-center"><Icon name="briefcase" size={14} className="mr-2 text-slate-400" />{c.occupation||'-'}</div>
                                                    <div className="flex items-center"><Icon name="mapPin" size={14} className="mr-2 text-slate-400" />{c.residentialArea||'-'}</div>
                                                </div>
                                                
                                                {(c.medicalHistory || c.remarks) && (
                                                    <div className="pt-2 border-t border-slate-100 mt-2 space-y-2">
                                                        {c.medicalHistory && <div className="text-xs bg-red-50 text-red-700 p-2 rounded border border-red-100">⚠️ {c.medicalHistory}</div>}
                                                        {c.remarks && <div className="text-xs bg-amber-50 text-amber-700 p-2 rounded border border-amber-100">📝 {c.remarks}</div>}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="px-4 py-2 bg-slate-50 border-t border-slate-200 flex justify-between items-center">
                                                <div className="flex flex-col gap-0.5">
                                                    <div className="text-[10px] text-slate-400">更新: {formatDate(c.updatedAt)}</div>
                                                    {c.isClient === 'already' && c.clientSinceDate && (
                                                        <div className="text-[10px] text-indigo-500 font-medium">🤝 客人: {c.clientSinceDate}</div>
                                                    )}
                                                </div>
                                                <div className="flex gap-3">
                                                    <button onClick={()=>handleEdit(c)} className="text-indigo-600 text-sm font-bold hover:underline">編輯</button>
                                                    <button onClick={()=>handleDelete(c.id)} className="text-red-400 text-sm font-bold hover:text-red-600">刪除</button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>
                </>
            );
        };

        const App = () => (
            <div className="min-h-screen flex flex-col max-w-md mx-auto md:max-w-5xl md:px-4">
                <GlobalErrorBoundary>
                    <MainContent />
                </GlobalErrorBoundary>
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>